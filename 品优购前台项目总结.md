## day01

## 相关链接

- 支付流程  https://open.alipay.com/platform/home.htm
- 接口文档  https://documenter.getpostman.com/view/130308/newshop/RVncfwwX
- 用户名itcast       密码123456

### 0. 搭建本地接口服务及测试

- 创建数据库 数据库名称 newshop 
- 找到 newshop.sql 文件 导入进去
- 修改数据库配置php-server\newshop\config\database.php，改成自己的密码
- 找到 目录 php-server/newshop 运行 start.cmd
- 如果遇到启动出现错误  vc14_redist.x86 安装补丁 重启电脑
- 如果启动不成功，建议使用在线的接口 https://documenter.getpostman.com/view/130308/newshop/RVncfwwX
- 使用postman接口调试 (GET  http://127.0.0.1:8000/v1/settings) 发现调接口需要认证
- 需要在每次请求的时候携带认证信息 'newshop-frontend' => 'd8667837fce5a0270a35f4a8fa14be479fadc774'，信息在\php-server\newshop\config\client.php中查看
- 在请求报文的头部进行设置 
    + username=newshop-frontend
    + password=d8667837fce5a0270a35f4a8fa14be479fadc774
- 认证信息 postman---Authorization，type选择 Basic auth 进行设置

###1. 创建项目目录结构

- app.js     入口文件 主体文件 使用MVC思想构建项目
- models/    数据模型 获取接口服务器数据
- views/      视图层  渲染页面
- controllers/     控制器  组织请求对应的url进行业务处理
- public/       静态资源
- utils/      工具类
- routers.js     组织路由
- middlewares.js      自定义中间件

1. 把静态资源放在public下面
2. 初始化package.json    npm init -y
3. package.json 添加描述*"description"*: "品优购前台",

### 2. 简易的web应用

1. 安装express -> npm i express

   `app.js`

   ```js
   const express = require('express')
   const app = express()
   app.listen(3000, () => {
       console.log("pyg64 Server Started")
   })
   ```

   node app.js 启动

2. 定义业务路由

   `app.js`

   ```js
   app.get('/', (req, res, next) => {
       res.send('server ok')
   })
   ```

   重新启动nodemon app.js

### 3. 错误统一处理

```js
/**3. 错误统一处理 */
/**3.1 资源未找到 */
app.use((req, res, next) => {
    // 走到这里，说明资源未找到(定义业务路由中写了所有的路由，如果前面的路由都不匹配，会来到这个中间件，说明资源未找到)
    // 如果请求走到这个中间件,证明所有的业务不符合URL,意思是资源未找到
    // 可以自己创建一个错误
    const error = new Error("Not Found")
    // 把错误交给下面的错误处理中间件
    next(error)
})
/**3.2 程序运行错误 */
// 错误处理中间件
app.use((err, req, res, next) => {
    // 运行的时候，程序有异常会走到这个中间件
    // 处理错误
    // 1. 如果是开发环境
    // 要能够直观的观察到异常信息，准确的定位到错误的代码
    
    // 2. 如果是生产环境(上线的，用户可以访问到的)
    // 返回漂亮的页面
    // 渲染两个类型的页面 404 和 500页面
})
```

####3.1 如何判断项目运行环境? cross-env 

  1. 计算机设置环境变量(windows系统下设置)
     - set NODE_ENV=production && node app.js
     - set NODE_ENV=development && modemon app.js
     - 通过`echo %NODE_ENV%`可以查看设置

  2. 或者使用cross-env环境变量设置，基于Node.js的命令行工具
     - cross-env NODE_ENV=production node app.js
     - cross-env NODE_ENV=development modemon app.js

  3. 在package.json文件中scripts中设置快捷启动命令

     ```json
     "start": "cross-env NODE_ENV=production node app.js",
     "dev": "cross-env NODE_ENV=development nodemon app.js"
     之后就可以使用npm run start 启动生产模式 ，npm run dev 启动开发模式
     ```

  4. 安装cross-env -> npm i cross-env -g 特点：跨平台，在不同的系统都可以使用  注意：设置是在内存中

####3.2 环境变量获取

怎么获取环境变量--express提供的方法(express官网可查)

```js
const env = req.app.get("env")
console.log(env);
```

让它出错，比如网址请求abc，进入到错误统一处理中间件，可以打印出环境变量

#### 3.3 开发环境-美化错误-准确定位错误位置---youch

1. npm i youch 

2. 看npm官网使用

   ```js
   const Youch = require('youch')
   if (env === "development") {
       // 1. 如果是开发环境
       // 要能够直观的观察到异常信息，准确的定位到错误的代码
       // -> 把具体的错误信息输出到页面，页面返回的是字符串，而err是对象，不能直接输出，这里使用youch包美化错误信息，准确定位错误位置 npm i youch
       // res.send(err)
       new Youch(err, req).toHTML().then((html) => res.send(html))
   }
   
   /**2. 定义业务路由 */
   app.get('/', (req, res, next) => {
       // 假如程序运行时错误，youch也可以定位到错误
       throw new Error("自己抛出异常")
       res.send('server ok')
   })
   ```

   可以在异常的时候在页面上展示详细的错误信息和错误信息位置

#### 3.4 生产环境-响应两个页面404-500页面

```js
// 2. 如果是生产环境
// 渲染两个类型的页面 404 和 500页面，美观一些
// 这里返回一个页面，设置不同的背景
// 动态返回页面error.art，放在views中，要返回页面，使用模板引擎art-template
/**4. 业务处理之前配置公用的中间件 */
/**4.1 配置模板引擎 art-template 服务端的模板引擎使用的是express-art-template */
```

####3.5 配置模板引擎express-art-template 

1. 安装 npm i express-art-template art-template

2. 在github上查看文档express-art-template

3. 导入express-art-template并配置

   ```js
   const artTemplate = require('express-art-template')
   /**4.1 配置模板引擎 art-template */
   app.engine('art', artTemplate); // 设置一个叫art的模板引擎，设置了模板引擎，就可以使用模板引擎的render方法
   ...
   res.render('error.art')
   ```

4.  

   ```js
   // 默认页面修改后被缓存了，而且被压缩了，模板引擎默认的是生产环境的配置
   // debug使用的是布尔值，false 开发环境 true 生产环境，开发环境需要->实时更新页面，不进行压缩
   app.set('view options', {
       // 开发环境才需要调试，生产环境不需要调试，这里需要判断环境
       // debug: ?
       // Node.js内置对象process，process.env是所有的环境变量
       debug: process.env.NODE_ENV === 'development'
       // 这样就分两种情况去处理页面了
   });
   ```

5. 生产环境下输出一个页面，需要区分是404还是500，

   ```js
   // 生产环境下输出一个页面，需要区分是404还是500，
   // 传递一个状态码给模板
   // 生产环境下无论是404还是500都会来到这里，我们可以在资源未找到的时候，给err加一个状态码
   // error.status = 404
   // 500的时候也需要加一个状态码
   // 介绍一个创建HTTP错误的插件http-errors
   ```
####3.6 创建HTTP错误的插件http-errors
   - 安装 npm i http-errors (npm官网看文档)

   - 导入

     ```js
     const createError = require('http-errors')
     /**2. 定义业务路由 */
     app.get('/', (req, res, next) => {
     	// 传递http-errors创建500错误
         throw createError(500,"Server Error")
         res.send('server ok')
     })
     
     /**3.1 资源未找到 */
     app.use((req, res, next) => {
         // 传递http-errors创建404的错误
         // 把错误交给下面的错误处理中间件
         next(createError(404, "Not Found"))
     })
     
     // 传递一个状态码给模板
     res.render('error.art', {
         status: err.status
     })
     // 可以使用{{status}}渲染，测试
     ```

6. error.art

   ```html
   <!DOCTYPE html>
   <html lang="en">
   <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <meta http-equiv="X-UA-Compatible" content="ie=edge">
       <title>ERROR PAGE</title>
       <style>
       .box{
           position:absolute;
           left:0;
           top:0;
           width:100%;
           height:100%;
           background-position:center;
           background-size:cover;
       }
       .error404{
           background-image:url('/assets/img/404.png')
       }
       .error500{
           background-image:url('/assets/img/500.png')
       }
       </style>
   </head>
   <body>
       <!--如果是404，显示404.png-->
       <!--如果是500，显示500.png-->
       <!-- <h1>{{status}}</h1>-->
       <!-- 在页面中写一个标签，设置类样式 -->
       <div class="box {{status==='404'?'error404':'error500'}}"></div>
   </body>
   </html>
   ```

#### 3.7 公布静态资源

1. 要想访问到图片，需要公布静态资源

   ```js
   const path = require('path')
   /**4.2 公布静态资源，这里不加前缀，公布public下的资源，使用绝对路径 */
   app.use('/', express.static(path.join(__dirname, '/public')))
   ```

2. 测试404和500页面 npm start

#### 3.8 处理网络图标请求--express-favicon中间件

安装  npm i express-favicon

```js
/**4.3 浏览器会自动发送网站小图标的请求，路径是 域名/favicon.ico ，*/
// 可以把图标放在public下面 ，如果公布静态资源的时候加了前缀，那么请求网页图标的路径就要加上public 
// 建议使用express-favicon统一处理小图标，这样icon的路径就可以放在任何位置，使用绝对路径
const favicon = require('express-favicon')
app.use(favicon(path.join(__dirname,'./favicon.ico')));
```



##day02

### 00 补充- ES6 数据类型 Symbol

ES6引入了一种新的原始数据类型Symbol，表示独一无二的值。

Symbol 值通过`Symbol`函数生成。这就是说，对象的属性名可以有两种类型：一种是字符串，另一种是Symbol类型。凡是属性名属于 Symbol 类型，就都是独一无二的，可以保证不会与其他属性名产生冲突

详见(https://www.cnblogs.com/sker/p/5474591.html)

### 01 首页-多重模板继承

语法：art-template官网--模板继承和子模板

有两个类型的模板：

- basic 提供给 登录页 类型的页面使用
- common 提供给 首页 类型的页面使用

1. views中新建layout/basic.art、common.art

   ```html
   "files.associations": {
           "*.art":"html" 
       },
   // vs code文件设置加上这段代码，就可以识别art文件了
   ```

2. basic.art中的代码参考home.html，提取最基本的页面结构和公共的css和script，挖坑

   ```html
   <!DOCTYPE html>
   <html>
   
   <head>
     <meta charset="utf-8">
     <title>品优购 - 优质！优质！</title>
     <link rel="stylesheet" href="assets/css/common.css">
     {{block 'styles'}}{{/block}}
   </head>
   
   <body>
     {{block 'body'}}{{/block}}
     <script src="assets/js/jquery.js"></script>
     <script src="assets/js/common.js"></script>
     <script src="assets/js/sui.transition.js"></script>
     {{block 'script'}}{{/block}}
   </body>
   
   </html>
   ```

3. common.art继承basic的模板，

4. 首页页面的顶部和底部是公用的部分，写成子模板，新建component/header.art、footer.art分别复制代码结构

   ```html
   模板引擎--art-template官网语法
   导入父模板语法
    {{extend './layout/basic.art'}}
   {{block 'head'}} ... {{/block}}
   
   导入子模板语法：
   {{include './header.art'}}
   
   ```

5. common.art分别导入basic.art和子模板header.art、footer.art

   ```htm
   <!-- 导入父模板 -->
   {{extend './basic.art'}}
   {{block 'body'}}
       {{include '../component/header.art'}}
       {{block 'content'}}{{/block}}
       {{include '../component/footer.art'}}
   {{/block}}
   ```

   

6. 新建views/home.art，主页，继承common.art模板，需要填三个坑

   - home主页的style
   - home主页的script
   - content

7. 测试能否渲染，app.js中，启动npm run dev

   ```js
   app.get('/', (req, res, next) => {
       res.render('home.art')
   })
   ```

8. 所有页面的图片路径改成绝对路径，加/

9. 猜你喜欢修改结构

   ```html
   <li class="yui3-u-1-6">
       <a href="item.html" class="pic"><img src="/uploads/like_01.png"></a>
       <p>阳光美包新款单肩包女包时尚子母包四件套女</p>
       <h3>¥116.00</h3>
   </li>
   ```

### 02 MVC 功能职责分析

![MVC功能职责](D:\北京顺义黑马前端与移动开发就业64期就业班\北京顺义黑马前端与移动开发就业64期(课程资料)\10品优购电商前台中间层项目\02\MVC功能职责.png)

### 03 处理网页关键字、网页描述

标题、网页描述等每个页面都要有，都应该渲染到页面上->在基础模板basic中应该有title、Keywords、description，每个网页都要有，所以写在basic.art中

1. 新建configs.js，设置网站公用信息

   ```js
   // 维护品优购项目所有的配置项
   
   /**1. 网站公用信息 */
   // site是站点的意思，导出
   exports.site = {
       title: '品优购(PYG.COM)-正品低价、品质保障、配送及时、轻松购物！',
       description: '品优购PYG.COM-专业的综合网上购物商城，为您提供正品低价的购物选择、优质便捷的服务体验。商品来自全球数十万品牌商家，囊括家电、手机、电脑、服装、居家、母婴、美妆、个护、食品、生鲜等丰富品类，满足各种购物需求。',
       Keywords: '网上购物,网上商城,家电,手机,电脑,服装,居家,母婴,美妆,个护,食品,生鲜,品优购'
   }
   ```

2. 这些信息每个页面都要有，所以每个路由里面都要设置，可以在中间件middlewares.js中暴露一个中间件全局的方法

   `middlewares.js`

   ```js
   // 自定义中间件
   const configs = require('./configs')
   /** 配置网站公用信息的方法 */
   exports.global = (req, res, next) => {
       res.locals.site = configs.site
       next()
       // 在处理路由之前，调用一下这个全局方法即可
   }
   ```

   `app.js`

   ```js
   const middlewares = require('./middlewares')
   app.use(middlewares.global)
   ```

3. 服务器返回页面的时候，在basic.art中通过{{}}渲染

   ```html
   <title>{{site.title}}</title>
   <meta name="description" content="{{site.description}}" />
   <meta name="Keywords" content="{{site.Keywords}}" />
   ```


### 04 控制器拆分

routers.js处理所有的路由，路由的处理函数放在controllers中，新建home.js

`router.js`

```js
// 组织所有的路由
const express = require('express')
const router = express.Router()
const homeController = require('./controllers/home.js')

// 添加若干个路由方法
router.get('/', homeController.index)
// 更多的业务路由

module.exports = router
```

`controllers/home.js`

```js
// 定义和首页相关的路由函数
exports.index = (req, res, next) => {
    // 渲染主页之前需要处理以下内容
    /**1. 轮播图数据获取 */
    /**2. 猜你喜欢数据获取 */
    /**3. 分类数据获取 */
    res.render('home.art')
}
```

### 05 首页-获取轮播图数据

拿数据在models中写，拿数据看接口文档，网站接口中settings(获取网站所有的设置信息)中"home_slides"是轮播图数据，新建models/settings.js

`settings.js`

```js
// 提供获取 设置相关数据 的函数
// 通过axios去请求php-server接口服务器

const {
    api
} = require('../configs')
// 通过axios去请求php-server接口服务器
// 1. 安装axios  npm i axios
// 2. 导入
const axios = require('axios')
// 3. 要考虑每次请求必须授权
// 4. 所以创建新的axios实例,自定义配置信息
const instance = axios.create({
    baseURL: api.baseURL,
    // 超时时间
    timeout: api.timeout,
    // 配置上认证信息
    auth: {
        username: api.username,
        password: api.password
    }
})
```

1. 安装axios  ->npm i axios

2. 导入

3. npm 官网看axios文档

4. 在configs.js写配置信息

   ```js
   /**2. 接口服务器配置信息 */
   exports.api = {
       // baseURL:'https://ns-api.uieee.com/v1/'  线上的url或者使用本地的url，本地的是http
       baseURL: 'http://localhost:8000/v1/',
       timeout: 3000,
       username: 'newshop-frontend',
       password: 'd8667837fce5a0270a35f4a8fa14be479fadc774'
   }
   ```

5. 调用axios，接口https://ns-api.uieee.com/v1/settings/:key  以key作为传参获取信息

   `settings.js`

   ```js
   // 5. 调用  提供一个获取数据的方法
   exports.getSliders = () => {
       // axios.get()返回一个promise对象，这里return一个.then的返回值，也就是return了一个promise对象，所以getSliders就是一个获取 promise对象的函数，通过getSliders.then获取到的就是res,data 
       return instance.get('settings/home_slides')
           .then(res => res.data)
           .catch(err => Promise.reject(err))
           // .catch(err => return err) 会当做成功的回调
           // .catch(err => Promise.reject(err)) 只有主动调用错误回调方法，才会被下一个catch捕获
   }
   ```

   `home.js`

   ```js
   // 定义和首页相关的路由函数
   const settingsModel = require('../models/settings.js')
   exports.index = (req, res, next) => {
       // 渲染主页之前需要处理以下内容
       /**1. 轮播图数据获取 */
       settingsModel.getSliders().then(data => {
           res.locals.sliders = data //挂载数据
           res.render('home.art')
       }).catch(err => next(err))
       /**2. 猜你喜欢数据获取 */
       /**3. 分类数据获取 */
       // res.render('home.art')
   }
   ```

   `app.js` 挂载路由

   ```js
   const router = require('./routers')
   ```

6. 封装axiosInstance实例(models/axiosInstance.js)，在settings.js中引入

   `axiosInstance.js`

   ```js
   const {
       api
   } = require('../configs')
   //通过axios去请求php-server接口服务器
   //1. 安装 npm i axios
   //2. 导入
   const axios = require('axios')
   //3. 考虑 每次请求必须授权
   //4. 自己创建新的axios实例
   const instance = axios.create({
       baseURL: api.baseURL,
       timeout: api.timeout,
       //配置上认证信息
       auth: {
           username: api.username,
           password: api.password
       }
   })
   // 5.导出
   module.exports = instance
   ```

7. home.art渲染轮播图

   ```html
   <!--banner轮播-->
   {{sliders}}
   <div id="banner" data-ride="carousel" data-interval="4000" class="sui-carousel slide">
       <!-- 小圆点 -->
       <ol class="carousel-indicators">
           {{each sliders }}
           <li data-target="#banner" data-slide-to="{{$index}}" class="{{$index==0?'active':''}}"></li>
           {{/each}}
       </ol>
       <div class="carousel-inner">
           {{each sliders}}
           <div class="item {{$index==0?'active':''}}"><a href="{{$value.link}}"><img src="{{$value.image}}"></a></div>
           {{/each}}
       </div>
       <a href="#banner" data-slide="prev" class="carousel-control left">‹</a>
       <a href="#banner" data-slide="next" class="carousel-control right">›</a>
   </div>
   ```

### 06 首页-猜你喜欢-渲染数据

1. 猜你喜欢的数据在models这一层从后台获取数据，新建models/product.js，postman测试接口https://ns-api.uieee.com/v1/products?type=like&limit=6

`product.js`

 ```js
const axios = require('./axiosInstance')
// 猜你喜欢
exports.getLikeProducts = () => {
    return axios.get(`products?type=like&limit=6`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
 ```

`home.js`

```js
const settingsModel = require('../models/settings')
const productModel = require('../models/product')

// 每次请求都要返回页面，是不可以的，既要请求轮播图数据，又要请求猜你喜欢数据，而且要等最慢的执行完毕之后，把两个结果合在一起，再返回页面，
// Promise.all() 可以执行多个异步操作promise操作，而且会等最慢的异步结果返回，才会去调用成功的回调(即.then)
// Promise.race() 可以执行多个异步操作promise操作，只要有异步操作返回结果，就会去调用成功的回调
// Promise.all() 传参：promise数组
/**1. 轮播图数据获取 */
/**2. 猜你喜欢数据获取 */
Promise.all([settingsModel.getSliders(), productModel.getLikeProducts()])
    .then(result => {
        // result 是多个异步操作的返回结果的集合，类型是数组，结果的顺序和传入的顺序一致
        // res.json(result)
        res.locals.sliders = result[0]
        res.locals.likes = result[1]
        res.render('home.art')
    }).catch(err => {
        // 只要有一个promise失败，就会执行这个catch
        next(err)
    })
```

`2. 渲染猜你喜欢`

```html
<div class="bd">
    <ul class="clearfix yui3-g Favourate picLB" id="picLBxxl">
        {{each likes}}
        <li class="yui3-u-1-6">
            <a href="/item/{{$value.id}}" class="pic"><img src="{{$value.thumbnail}}"></a>
            <p>{{$value.name}}</p>
            <h3>¥{{$value.price}}</h3>
        </li>
        {{/each}}
    </ul>
</div>
```

刷新网页，可以看到猜你喜欢的数据变化

### 07 首页-猜你喜欢-换一换

1. 点击换一换，不是直接给接口服务器请求数据，而是给中间层，只有中间层向服务器发请求，才能拿到数据，中间层应该暴露一个接口

   ```js
   // 返回猜你喜欢json格式的数据
   exports.like = (req, res, next) => {
       productModel.getLikeProducts().then(data => {
           // 以json格式返回
           res.json({
               status: 200,
               result: data
           })
       }).catch(err => {
           // next走错误处理中间件  响应客户端的是错误页面
           // next(err)
           // 错误信息也应该以json格式返回，不走错误处理中间件
           // 为了区分是成功还是失败返回的数据，返回的时候传一个状态码
           res.json({
               status: 500,
               msg: err.message //ERROR对象中的错误信息是message属性
           })
       })
   }
   ```

2. 请求的时候，先走app.js，然后走routers.js，在routers.js中配置路由

   ```js
   router.get('/like', homeController.like)
   ```

3. 测试数据http://localhost:3000/like

4. 点击换一换的时候调用接口

   ```js
   <script>
       $(function(){
           $('#xxlChg').on('click',function () {
               console.log(111111)
               // 发请求，获取数据，渲染
               $.get('/like',function (data) {
                   console.log(data)
                   // 遍历result，拼接字符串
                   let html=''
                   data.result.forEach(($value,i) => {
                       html+=
                       `
                           <li class="yui3-u-1-6">
                               <a href="/item/${$value.id}" class="pic"><img src="${$value.thumbnail}"></a>
                               <p>${$value.name}</p>
                               <h3>¥${$value.price}</h3>
                           </li>
                       `
                   });
                   // console.log(html)
                   $('#picLBxxl').fadeOut(function () {
                       $(this).html(html).fadeIn()
                   })
               })
           })
       })
   </script>
   ```

### 08 首页-分类数据获取

分类：左侧导航和搜索分类都会用到，我们应该在公共的中间件中去拿数据middlewares.js

postman测试接口http://127.0.0.1:8000/v1/categories?format=tree

在modules中拿数据，category.js

`category.js`

```js
// 分类相关获取函数数据
const axios = require('./axiosInstance')
exports.getCategoryTree = () => {
    return axios.get(`categories?format=tree`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`middlewares.js`

```js
const categoryModel = require('./models/category')
exports.global = (req, res, next) => {
    // 1. 网站公用的头部信息
    res.locals.site = configs.site
    // 2. 分类信息
    categoryModel.getCategoryTree()
        .then(data => {
            res.locals.categoryTree = data
            next()
        }).catch(err => next(err))
    // 在处理路由之前，调用一下这个全局方法即可
}
```

### 09 首页-分类数据-渲染

```html
<div class="yui3-g NavList">
    <div class="all-sorts-list">
        <div class="yui3-u Left all-sort">
            <h4>全部商品分类</h4>
        </div>
        <div class="sort">
            <div class="all-sort-list2">
                {{each categoryTree item i}}
                <div class="item">
                    <h3><a href="/list/{{item.id}}">{{item.name}}</a></h3>
                    <div class="item-list clearfix">
                        <div class="subitem">
                            {{each item.children subItem i}}
                            <dl>
                                <dt><a href="/list/{{subItem.id}}">{{subItem.name}}</a></dt>
                                <dd>
                                    {{each subItem.children lastItem i}}
                                    <em><a href="/list/{{lastItem.id}}">{{lastItem.name}}</a></em>
                                    {{/each}}
                                </dd>
                            </dl>
                            {{/each}}
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>
        </div>
    </div>
    <div class="yui3-u Center navArea">
        <ul class="nav">
            <li class="f-item">服装城</li>
            <li class="f-item">美妆馆</li>
            <li class="f-item">品优超市</li>
            <li class="f-item">全球购</li>
            <li class="f-item">闪购</li>
            <li class="f-item">团购</li>
            <li class="f-item">有趣</li>
            <li class="f-item">秒杀</li>
        </ul>
    </div>
    <div class="yui3-u Right"></div>
</div>
```



## day03

### 01 首页-分类数据加载优化处理

`middlewares.js`

```js
// 2. 分类信息
// 2.1 问题：每一次请求，都会去获取分类数据，想做缓存
// 2.2 获取一次分类数据，就缓存起来，可以存在内存中，用一个全局变量保存起来，这里不能用cookie、session等，因为这是浏览器提供的API
// 2.3 global这个全局对象是暴露给所有的程序使用，这里的内容可能会被其他程序覆盖，不建议在这里保存
// 2.4 req和res对象，每次请求都会重新创建，可以存在req.app里面，启动web应用的时候，会创建app，一个应用只有一个app，可以
// 2.5 思路：如果缓存中有数据，就走缓存，没有，就发请求给接口服务器获取
if (req.app.locals.categoryTree) {
    res.locals.categoryTree = req.app.locals.categoryTree
    next()
} else {
    categoryModel.getCategoryTree()
        .then(data => {
            // 拿到数据之后，做缓存
            req.app.locals.categoryTree = data
            res.locals.categoryTree = data
            next()
        }).catch(err => next(err))
    // 在处理路由之前，调用一下这个全局方法即可
}
```

### 02 商品列表-渲染列表页

####2.1 分类商品查询路由规则

`router.js`

```js
const listController = require('./controllers/list')
// 列表页路由
// restful 路由规则，根据id查询数据
router.get('/list/:id', listController.index)
```

`controllers/list.js`

```js
// 商品列表相关路由方法
exports.index = (req, res, next) => {
    // 获取某个分类下的商品列表(点的分类)
    // 获取客户端的传参
    // 如果是get ?id=10  req.query
    // 如果是post 参数看不见 req.body
    // 如果是url/10  req.params
    // res.json(req.params)
    const id = req.params.id
    // res.send('list')
}
```

#### 2.2 获取restful的参数使用req.params

```js
const id = req.params.id
```

#### 2.3 列表--获取商品列表数据

`products.js`

```js
// 获取分类下的商品列表 包含分页信息
exports.getProductAndCategory = (id, page, per_page) => {
    return axios.get(`categories/${id}/products?page=${page}&per_page=${per_page}`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`list.js`

```js
const productModel = require('../models/product')
exports.index = (req, res, next) => {
    // 获取某个分类下的商品列表(点的分类)
    // 获取客户端的传参
    // 如果是get ?id=10  req.query
    // 如果是post 参数看不见 req.body
    // 如果是url/10  req.params
    // res.json(req.params)
    const id = req.params.id
    const page = req.query.page || 1 //获取分页的页码
    const per_page = 10 //自己确定好的
    productModel.getLikeProducts(id, page, per_page)
        .then(data => {
            res.json(data)
        }).catch(err => next(err))
    // res.send('list')
}
```

浏览器中测试数据http://localhost:3000/list/6

#### 2.4 列表--获取分页信息

`products.js`

```js

// 获取分类下的商品列表 包含分页信息
exports.getProductAndCategory = (id, page, per_page) => {
    return axios.get(`categories/${id}/products?page=${page}&per_page=${per_page}`)
        .then(res => ({
            list: res.data,
            page: +res.headers['x-current-page'],
            total: +res.headers['x-total-pages']
        })) //返回一个对象
        // page: res.headers['x-current-page'],得到的数据是字符串，要转换成数字
        // res是响应对象，理解成响应报文(有响应状态行、响应头、响应体)
        // res.data是响应体，是json数据
        // 分页信息在res.headers响应头中
        // "headers": {
        //     "host": "localhost:8000",
        //     "date": "Fri, 01 Mar 2019 10:40:14 +0800",
        //     "connection": "close",
        //     "x-powered-by": "PHP/7.1.25",
        //     "content-type": "application/json; charset=utf-8",
        //     "x-total-count": "40",
        //     "x-total-pages": "4",
        //     "x-limit-count": "10",
        //     "x-current-page": "1",
        //     "link": "<http://127.0.0.1:8000/index.php/v1/categories/1/products?page=2&per_page=10>; rel=next, <http://127.0.0.1:8000/index.php/v1/categories/1/products?page=4&per_page=10>; rel=last"
        //     }
        .catch(err => Promise.reject(err))
}
```

此时res.json(data)中就有三个数据,通过http://localhost:3000/list/1测试

#### 2.5 列表--获取面包屑导航

根据当前分类查找有没有上一级，然后再查找有没有上上级

postman测试，https://ns-api.uieee.com/v1/categories/:id?include=parent,children，这里不需要子集，只需要父级或上上级，这里传的是参数id=8=>http://127.0.0.1:8000/v1/categories/8?include=parent

`category.js`

```js
// 获取某一个分类及其父级分类
exports.getCategoryAndParent = (id) => {
    return axios.get(`categories/${id}?include=parent`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`list.js`

```js
const categoryModel = require('../models/category')
exports.index = (req, res, next) => {
    const id = req.params.id
    const page = req.query.page || 1 //获取分页的页码
    const per_page = 10 //自己确定好的
    /**
     * 需求
     * 1.列表信息
     * 2.分页信息
     * 3.面包屑导航
     * 4.排序信息
     */
    // productModel.getProductAndCategory(id, page, per_page)
    //     .then(data => {
    //         res.json(data)
    //     }).catch(err => next(err))
    // res.send('list')
    // 同时获取列表、分页和面包屑数据
    Promise.all([productModel.getProductAndCategory(id, page, per_page), categoryModel.getCategoryAndParent(id)])
        .then(result => res.json(result))
        .catch(err => next(err))
}
```

测试http://localhost:3000/list/8

#### 2.6 列表--排序信息

`list.js`

```js
// commend 综合排序
// quantity 销量排序
// market_time 新品排序
// -price 价格升序
// price 价格降序
const sort = req.query.sort || 'commend'
// 同时获取列表、分页和面包屑数据，传入排序
Promise.all([productModel.getProductAndCategory(id, page, per_page, sort), categoryModel.getCategoryAndParent(id)])
    .then(result => res.json(result))
    .catch(err => next(err))
```

`products.js`传入排序参数

```js
// 获取分类下的商品列表 包含分页信息
exports.getProductAndCategory = (id, page, per_page, sort) => {
    return axios.get(`categories/${id}/products?page=${page}&per_page=${per_page}&sort=${sort}`)
        .then(res => ({
            list: res.data,
            page: +res.headers['x-current-page'],
            total: +res.headers['x-total-pages']
        })) //返回一个对象
        .catch(err => Promise.reject(err))
}
```

#### 2.7 列表--静态模板

1. 返回一个list.art ，新建views/list.art

    `res.json(result)`=> ` res.render('list.art')`

2. list.art可以参照home.art，两者结构一样

3. 修改图片的路径，css路径，前面加/

4. 测试http://localhost:3000/list/8

   ```html
   {{extend './lauout/common.art'}}
   {{block 'styles'}}
   <link rel="stylesheet" href="/assets/css/page-list.css">
   {{/block}}
   {{block 'script'}}{{/block}}
   {{block 'content'}}
   <!--list-content-->
   <div class="main">
       <div class="py-container">
           <!--bread-->
           <div class="bread">
               <ul class="fl sui-breadcrumb">
                   <li class="active">智能手机</li>
               </ul>
           </div>
           <!--selector-->
           <div class="clearfix selector">
               <div class="type-wrap">
                   <div class="fl key">摄像头像素</div>
                   <div class="fl value">
                       <ul class="type-list">
                           <li><a>1200万以上</a></li>
                           <li><a>800-1199万</a></li>
                           <li><a>1200-1599万</a></li>
                           <li><a>1600万以上</a></li>
                           <li><a>无摄像头</a></li>
                       </ul>
                   </div>
               </div>
               <div class="type-wrap">
                   <div class="fl key">价格</div>
                   <div class="fl value">
                       <ul class="type-list">
                           <li><a>0-500元</a></li>
                           <li><a>500-1000元</a></li>
                           <li><a>1000-1500元</a></li>
                           <li><a>1500-2000元</a></li>
                           <li><a>2000-3000元 </a></li>
                           <li><a>3000元以上</a></li>
                       </ul>
                   </div>
               </div>
           </div>
           <!--details-->
           <div class="details">
               <div class="sui-navbar">
                   <div class="navbar-inner filter">
                       <ul class="sui-nav">
                           <li class="active"><a href="#">综合</a></li>
                           <li><a href="#">销量</a></li>
                           <li><a href="#">新品</a></li>
                           <li><a href="#">评价</a></li>
                           <li><a href="#">价格</a></li>
                       </ul>
                   </div>
               </div>
               <div class="goods-list">
                   <ul class="yui3-g">
                       <li class="yui3-u-1-5">
                           <div class="p-img"><a href="item.html"><img src="/uploads/mobile.png"></a></div>
                           <div class="price"><strong><em>¥</em><i>6088.00</i></strong></div>
                           <div class="attr"><em>Apple苹果iPhone 6s (A1699)</em></div>
                           <div class="commit"><i class="command">已有2000人评价</i></div>
                           <div class="operate">
                               <a href="cart-add.html" class="sui-btn btn-bordered btn-danger">加入购物车</a>
                               <a href="#" class="sui-btn btn-bordered">对比</a>
                               <a href="#" class="sui-btn btn-bordered">关注</a>
                           </div>
                       </li>
                       <li class="yui3-u-1-5">
                           <div class="p-img"><a href="item.html"><img src="/uploads/mobile.png"></a></div>
                           <div class="price"><strong><em>¥</em><i>6088.00</i></strong></div>
                           <div class="attr"><em>Apple苹果iPhone 6s (A1699)</em></div>
                           <div class="commit"><i class="command">已有2000人评价</i></div>
                           <div class="operate">
                               <a href="cart-add.html" class="sui-btn btn-bordered btn-danger">加入购物车</a>
                               <a href="#" class="sui-btn btn-bordered">对比</a>
                               <a href="#" class="sui-btn btn-bordered">关注</a>
                           </div>
                       </li>
                       <li class="yui3-u-1-5">
                           <div class="p-img"><a href="item.html"><img src="/uploads/mobile.png"></a></div>
                           <div class="price"><strong><em>¥</em><i>6088.00</i></strong></div>
                           <div class="attr"><em>Apple苹果iPhone 6s (A1699)</em></div>
                           <div class="commit"><i class="command">已有2000人评价</i></div>
                           <div class="operate">
                               <a href="cart-add.html" class="sui-btn btn-bordered btn-danger">加入购物车</a>
                               <a href="#" class="sui-btn btn-bordered">对比</a>
                               <a href="#" class="sui-btn btn-bordered">关注</a>
                           </div>
                       </li>
                       <li class="yui3-u-1-5">
                           <div class="p-img"><a href="item.html"><img src="/uploads/mobile.png"></a></div>
                           <div class="price"><strong><em>¥</em><i>6088.00</i></strong></div>
                           <div class="attr"><em>Apple苹果iPhone 6s (A1699)</em></div>
                           <div class="commit"><i class="command">已有2000人评价</i></div>
                           <div class="operate">
                               <a href="cart-add.html" class="sui-btn btn-bordered btn-danger">加入购物车</a>
                               <a href="#" class="sui-btn btn-bordered">对比</a>
                               <a href="#" class="sui-btn btn-bordered">关注</a>
                           </div>
                       </li>
                   </ul>
               </div>
               <div class="fr page">
                   <div class="sui-pagination pagination-large">
                       <ul>
                           <li class="prev disabled"><a href="#">«上一页</a></li>
                           <li class="active"><a href="#">1</a></li>
                           <li><a href="#">2</a></li>
                           <li><a href="#">3</a></li>
                           <li><a href="#">4</a></li>
                           <li><a href="#">5</a></li>
                           <li class="dotted"><span>...</span></li>
                           <li class="next"><a href="#">下一页»</a></li>
                       </ul>
                       <div>
                           <span>共10页</span>
                           <span>到第 <input type="text" class="page-num"> 页 <button class="page-confirm">确定</button></span>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>
   {{/block}}
   ```

#### 2.8 渲染面包屑导航

`list.js`

```js
// 设置面包屑数据
res.locals.breadcrumb = result[1]
```

`list.art`

```html
{{breadcrumb}}
1. 渲染，判断是否有父级，
2. 加链接，使之能进行跳转
<!--bread-->
<div class="bread">
    <ul class="fl sui-breadcrumb">
        <!-- {{breadcrumb}} -->
        <!-- 判断当前的面包屑是否有父级，有父级才去渲染li -->
        {{if breadcrumb.parent && breadcrumb.parent.parent}}
        <li><a href="/list/{{breadcrumb.parent.parent.id}}">{{breadcrumb.parent.parent.name}}</a></li>
        {{/if}}
        {{if breadcrumb.parent}}
        <li><a href="/list/{{breadcrumb.parent.id}}">{{breadcrumb.parent.name}}</a></li>
        {{/if}}
        <li class="active">{{breadcrumb.name}}</li>
    </ul>
</div>
```

#### 2.9 排序渲染

`list.js`

```js
// 设置当前排序
res.locals.sort = sort
```

`list.art`

```html
<div class="navbar-inner filter">
    <ul class="sui-nav">
        <!-- id是面包屑的id -->
        <li class="{{sort=='commend'?'active':''}}"><a href="/list/{{breadcrumb.id}}?sort=commend">综合</a></li>
        <li class="{{sort=='quantity'?'active':''}}"><a href="/list/{{breadcrumb.id}}?sort=quantity">销量</a></li>
        <li class="{{sort=='market_time'?'active':''}}"><a href="/list/{{breadcrumb.id}}?sort=market_time">新品</a></li>
        {{if sort.includes('price')}}
        <li class="active"><a href="/list/{{breadcrumb.id}}?sort={{sort=='price'?'-price':'price'}}">价格<i class="sui-icon {{sort=='price'?'icon-tb-unfold':'icon-tb-fold'}}"></i></a></li>
        {{else}}
        <!-- 默认是升序，当选中的时候，再去点击是降序 -->
        <li><a href="/list/{{breadcrumb.id}}?sort=-price">价格</a></li>
        {{/if}}
    </ul>
</div>
```

排序的箭头使用SUI的图标，SUI官网-图标，找到图标，复制类名

测试http://localhost:3000/list/8?sort=price

#### 3.0 商品列表展示

`list.js`

```js
// 设置商品列表数据
res.locals.list = result[0].list
```

根据数组的长度判断有无指定条件下的商品

```html
<div class="goods-list">
    <!-- 根据数组的长度判断有无指定条件下的商品 -->
    {{if list.length}}
    <ul class="yui3-g">
        {{each list item i}}
        <li class="yui3-u-1-5">
            <div class="p-img"><a href="/item/{{item.id}}"><img src="{{item.thumbnail}}"></a></div>
            <div class="price"><strong><em>¥</em><i>{{item.price}}</i></strong></div>
            <div class="attr"><em>{{item.name}}</em></div>
            <div class="commit"><i class="command">已有2000人评价</i></div>
            <div class="operate">
                <a href="/cart/add/{{item.id}}" class="sui-btn btn-bordered btn-danger">加入购物车</a>
                <a href="#" class="sui-btn btn-bordered">对比</a>
                <a href="#" class="sui-btn btn-bordered">关注</a>
            </div>
        </li>
        {{/each}}
    </ul>
    {{else}}
    <!-- SUI组件 -->
    <div class="sui-msg msg-large msg-block msg-tips">
        <div class="msg-con">亲，没有找到该条件下的商品！</div>
        <s class="msg-icon"></s>
    </div>
    {{/if}}
</div>
```

#### 3.1 列表-分页

![1551448888182](C:\Users\初见\AppData\Roaming\Typora\typora-user-images\1551448888182.png)

 

1. 分页，数据列表会用到分页，按关键字查询也会用到分页，所以我们可以封装一个分页工具方法utils/pagination.js

   `pagination.js`

   ```js
   // 目的：返回分页的HTML格式的代码
   module.exports = (options) => {
       /**1.准备封装分页组件需要的 数据 
        * 数据有page total btnNum 不能直接写参数，因为参数的顺序是不确定的，这里传递options，类型是对象，
        * options {page,total,btnNum}btnNum可以传，不传就采用默认值，page和total是必须传的
        */
       if (!(options.page && options.total)) return ''
       const {
           page,
           total
       } = options
       const btnNum = options.btnNum || 5
       /**2.准备封装分页组件需要的 模板 */
   
       return '分页html格式代码'
   }
   ```

2. 我们要返回一个分页的html代码，不能写在js代码中，可以在views/component中单独建一个模板来写分页的HTML  ->pagination.art

3. 计算起始页码和结束页码

   ```js
   /**3. 计算起始页码和结束页码 */
   /**a. 理想情况 */
   let end = page + Math.floor(btnNum / 2)
   let start = end - btnNum + 1
   /**b. end值大于总页数 */
   end = end > total ? total : end
   start = end - btnNum + 1
   /**c. 如果start小于1 */
   start = start < 1 ? 1 : start
   end = start + btnNum - 1
   /**d. end值大于总页数 */
   end = end > total ? total : end
   ```

4. 使用art-template

5. 分页---渲染

   `pagination.art`

   ```html
   <!-- 大于1页才有分页的必要 -->
   {{if total > 1}}
   <div class="fr page">
       <div class="sui-pagination pagination-large">
           <ul>
               {{if page > 1}}
               <li class="prev"><a href="#">«上一页</a></li>
               {{else}}
               <li class="prev disabled"><a href="javascript:;">«上一页</a></li>
               {{/if}}
               {{if start > 1}}
               <li class="dotted"><span>...</span></li>
               {{/if}}
               <!-- 从起始按钮开始，遍历到结束按钮结束 -->
               <!-- <% 内部只能写js代码 %> -->
               <% for(var i=start; i<=end; i++) { %>
                   <li class="<%= i==page? 'active' : '' %>"><a href="#"><%=i%></a></li>
               <% } %>
               {{if end < total }}
               <li class="dotted"><span>...</span></li>
               {{/if}}
               {{if page < total}} <li class="next"><a href="#">下一页»</a></li>
               {{else}}
               <li class="next disabled"><a href="javascript:;">下一页»</a></li>
               {{/if}}
           </ul>
           <div>
               <span>共{{total}}页</span>
               <span>到第 <input type="text" class="page-num"> 页 <button class="page-confirm">确定</button></span>
           </div>
       </div>
   </div>
   {{/if}}
   ```

   

   ```js
   const path = require('path')
   const template = require('art-template')
   /**4. 结合数据和模板 动态生成分页HTML格式代码 */
   /**artTemplate可以在浏览器端使用， template(模板ID,数据)*/
   /**artTemplate可以在Node.js使用， template(模板路径,数据)*/
   const templateUrl = path.join(__dirname, '../views//component/pagination.art')
   const  html= template(templateUrl, {
       page,
       total,
       btnNum,
       start,
       end
   })
   ```

   `list.js`列表页需要分页代码

   ```js
   const pagination = require('../utils/pagination')
   // 分页代码
   const html = paginationUtil(page: result[0].page, total: result[0].total)
   res.locals.pageHtml = html
   ```

   `list.art`中渲染{{@pageHtml}}

   `// artTemplate 输出的HTML格式的代码，默认是字符串输出，防止XSS攻击cross site script(防止和CSS混淆，简写XSS),使用时用@`

   测试分页http://localhost:3000/list/1?page=5

   

## day04

### 01 分页-修改url中的page

`pagination.js`

```js
/**--------实现分页按钮的跳转-----------*/
/**1.需要跳转的url地址 /list/1?sort=commend&page=1
* 2.url需要包含其他传参，其他传参保持不变，当前页码的page的值要改变，
* 3.url操作在js中进行方便一些
* 4.url本身是字符串，操作不方便，可以转换成对象，使用url内置模块
* 5.使用url内置模块转换成对象
*/
// const urlObject = url.parse(options.url) //可以在list.js传参的时候，把url传进来,urlObject.query是键值对字符串
const urlObject = url.parse(options.url, true) //urlObject.query是对象
// console.log(urlObject);
/**6.可以比较方便的修改page，但是修改的page的值，只有在模板中才知道
* 7.可以定义一个函数，可以传参，page，定义一个函数，动态的拿到url地址
* 8.修改query中的page参数
*/
const getUrl = (page) => {
   // 8.修改query中的page参数
   urlObject.query.page = page
   // 9.把对象转换成url地址
   urlObject.search = undefined//只有当search是undefined的时候，才会用query去拼接地址
   const urlStr = url.format(urlObject)
   return urlStr
}
// console.log(getUrl(4));
```

   

### 02 分页-页码按钮功能实现

在模板中调用getUrl()方法

`pagination.js`

```js
/**10.模板内无法使用外部的变量 ，可以通过参数传递进去getUrl*/
const html = template(templateUrl, {
    page,
    total,
    btnNum,
    start,
    end,
    getUrl
})
```

`pagination.art`

```html
<li class="prev disabled"><a href="javascript:;">«上一页</a></li>

<% for(var i=start; i<=end; i++) { %>
    <li class="<%= i==page? 'active' : '' %>"><a href="{{getUrl(i)}}"><%=i%></a></li>
<% } %>

<li class="next"><a href="{{getUrl(page+1)}}">下一页»</a></li>
```

### 03 分页-点击确认跳转输入的页码

点击确认，根据输入的页码可以进行跳转

`pagination.js`

```js
/**-----实现点击确认，根据输入的页码进行跳转------*/
/**1.如果通过js实现，并且在浏览器端运行，操作麻烦
* 2.可以使用form表单提交，提交的时候除了提交输入的page，之前的url上的参数也进行提交
* 在表单内生成其他传参的隐藏的输入框，只显示page输入框即可
*/
pathname: urlObject.pathname,
query: urlObject.query
```

`pagination.art`

```html
 <div>
    <span>共{{total}}页</span>
    <!-- 表单提交必须有名字name 
    在表单提交的时候，原来地址栏有多少个参数，还应该保留多少个参数，通过query: urlObject.query传进来
    -->
    <form action="{{pathname}}" autocomplete="off" style="display:inline-block">
        <span>
            <!-- 根据query传参,query是一个对象，得到有多少个input -->
            {{each query value key}}
            {{if key!=='page'}}
            <input type="hidden" name="{{key}}" value="{{value}}">
            {{/if}}
            {{/each}}
            到第
            <input name="page" type="text" class="page-num"> 页
            <button class="page-confirm">确定</button>
        </span>
    </form>
</div>
```

### 04 搜索-路由规则定义

通过搜索关键字可以来到列表页

`router.js`

```js
router.get('/search', listController.search)
```

`list.js`

```js
// 按搜索关键字查询
exports.search = (req, res, next) => {
    res.send('ok')
}
```

`header.art`

```html
<!-- action 提交的地址/search -->
<form action="/search" autocomplete="off" class="sui-form form-inline">
    <div class="input-append">
        <!-- 设置表单提交的name属性 -->
        <input type="text"  name="q" class="input-error input-xxlarge">
        <!-- 按钮没有去掉type属性才能提交 -->
        <button class="sui-btn btn-xlarge btn-danger">搜索</button>
    </div>
</form>
```

搜索，测试路由能走通

### 05 搜索-获取列表数据-url中传中文及特殊符号

`list.js`

```js
// 按搜索关键字查询
exports.search = (req, res, next) => {
    /**需求
     * 1.搜索框提示关键字
     * 2.原来的面包屑位置，是搜索提示
     * 3.排序的位置需要修改地址
     * 4.列表数据渲染
     * 5.分页渲染
     */
    // 关键字
    const q = req.query.q
    const sort = req.query.sort || 'commend'
    const page = req.query.page || 1
    const per_page = 5
    // 根据关键字查询查询商品列表数据和分页数据
    
    // res.render('list.art') // 和list的相似度很高，可以共用一个模板
}
```

`models/products.js`

```js
// 获取搜索关键字下的商品列表 包含分页信息
exports.getProductBySearch = (q, page, per_page, sort) => {
    // 接口，products
    return axios.get(`products?page=${page}&per_page=${per_page}&sort=${sort}&q=${q}`)
        .then(res => ({
            list: res.data,
            page: +res.headers['x-current-page'],
            total: +res.headers['x-total-pages']
        }))
        .catch(err => Promise.reject(err))
}
```

`list.js`

```js
// 根据关键字查询查询商品列表数据和分页数据
productModel.getProductBySearch(q, page, per_page, sort)
    .then(data => {
        res.json(data)
    })
    .catch(err => next(err))
```

测试`http://localhost:3000/search?q=%E7%94%B5%E8%A7%86`，报错`Request path contains unescaped characters`

postman测试，没有问题

http://127.0.0.1:8000/v1/products?page=1&per_page=10&q=电视

原因：`models/products.js`

```js
// 地址栏传参，如果是中文字符或特殊字符，会解析异常
// 一般url在传递数据的时候，要转成url编码encodeURIComponent 解码是decodeURIComponent
q = encodeURIComponent(q)
```

### 06 搜索-页面渲染

`list.js`

```js
// 设置关键字信息
res.locals.q = q
// 排序
res.locals.sort = sort
// 列表数据
res.locals.list = data.list
// 分页
res.locals.pageHtml = paginationUtil({
    page: data.page,
    total: data.total,
    url: req.url
})
res.render('list.art') 
```

模板中有面包屑数据就是分类下面的列表，没有面包屑就是搜索关键字的列表

`list.art`

```html
<div class="bread">
    <ul class="fl sui-breadcrumb">
        <!-- 模板中有面包屑数据就是分类下面的列表，没有面包屑就是搜索关键字的列表 -->
        {{if breadcrumb}}
        <!-- {{breadcrumb}} -->
        <!-- 判断当前的面包屑是否有父级，有父级才去渲染li -->
        {{if breadcrumb.parent && breadcrumb.parent.parent}}
        <li><a href="/list/{{breadcrumb.parent.parent.id}}">{{breadcrumb.parent.parent.name}}</a></li>
        {{/if}}
        {{if breadcrumb.parent}}
        <li><a href="/list/{{breadcrumb.parent.id}}">{{breadcrumb.parent.name}}</a></li>
        {{/if}}
        <li class="active">{{breadcrumb.name}}</li>
        {{/if}}
    </ul>
</div>



<div class="sui-navbar">
    <div class="navbar-inner filter">
        <!-- 如果有面包屑数据，就渲染这个ul -->
        {{if breadcrumb}}
        <ul class="sui-nav">
            <!-- id是面包屑的id -->
            <li class="{{sort=='commend'?'active':''}}"><a href="/list/{{breadcrumb.id}}?sort=commend">综合</a></li>
            <li class="{{sort=='quantity'?'active':''}}"><a href="/list/{{breadcrumb.id}}?sort=quantity">销量</a></li>
            <li class="{{sort=='market_time'?'active':''}}"><a href="/list/{{breadcrumb.id}}?sort=market_time">新品</a></li>
            {{if sort.includes('price')}}
            <li class="active"><a href="/list/{{breadcrumb.id}}?sort={{sort=='price'?'-price':'price'}}">价格<i
                        class="sui-icon {{sort=='price'?'icon-tb-unfold':'icon-tb-fold'}}"></i></a></li>
            {{else}}
            <!-- 默认是升序，当选中的时候，再去点击是降序 -->
            <li><a href="/list/{{breadcrumb.id}}?sort=-price">价格</a></li>
            {{/if}}
        </ul>
        {{/if}}
    </div>
</div>
```

显示关键字`header.art`

```html
<input type="text"  name="q" value="{{q}}" class="input-error input-xxlarge">
```

显示搜索提示，如果有面包屑数据，就显示面包屑导航，如果没有面包屑数据，就显示搜索提示

`list.art`

```html
{{else}}
<li class="active">搜索"{{q}}"的结果：</li>



{{else}}
<ul class="sui-nav">
    <!-- id是面包屑的id -->
    <li class="{{sort=='commend'?'active':''}}"><a href="/search?q={{q}}&sort=commend">综合</a></li>
    <li class="{{sort=='quantity'?'active':''}}"><a href="/search?q={{q}}&sort=quantity">销量</a></li>
    <li class="{{sort=='market_time'?'active':''}}"><a href="/search?q={{q}}&sort=market_time">新品</a></li>
    {{if sort.includes('price')}}
    <li class="active"><a href="/search?q={{q}}&sort={{sort=='price'?'-price':'price'}}">价格<i
                class="sui-icon {{sort=='price'?'icon-tb-unfold':'icon-tb-fold'}}"></i></a></li>
    {{else}}
    <!-- 默认是升序，当选中的时候，再去点击是降序 -->
    <li><a href="/search?q={{q}}&sort=-price">价格</a></li>
    {{/if}}
</ul>
```

### 07 商品详情-路由规则

`router.js`

```js
const itemController = require('./controllers/item')
// 详情
router.get('/item/:id', itemController.index)
```

`controllers/item.js`

```js
// 商品详情页相关路由函数
exports.index = (req, res, next) => {
    res.send('ok')
}
```

### 08 商品详情-静态模板

`controllers/item.js`

```js
// 商品详情页相关路由函数
exports.index = (req, res, next) => {
    res.render('item.art')
}
```

`views/item.art`

1. 复制需要的css，script

2. 修改静态资源的路径，前面加/

   ```html
   {{extend './lauout/common.art'}}
   {{block 'styles'}}
   <link rel="stylesheet" href="/assets/css/page-item.css">
   <link rel="stylesheet" href="/assets/css/xzoom.css">
   {{/block}}
   {{block 'script'}}
   <script src="/assets/js/sui.tab.js"></script>
   <script src="/assets/js/xzoom.min.js"></script>
   <script>
       $(function ($) {
             $('.xzoom, .xzoom-gallery').xzoom({ tint: '#888', Xoffset: 15 })
           })
   </script>
   {{/block}}
   {{block 'content'}}
   <div class="main">
       <div class="py-container">
           <div class="crumb-wrap">
               <ul class="sui-breadcrumb">
                   <li><a href="#">手机、数码、通讯</a></li>
                   <li><a href="#">手机</a></li>
                   <li><a href="#">Apple苹果</a></li>
                   <li class="active">iphone 6S系类</li>
               </ul>
           </div>
           <!--product-info-->
           <div class="product-info">
               <div class="fl preview-wrap">
                   <!--放大镜效果-->
                   <div class="zoom">
                       <!--默认第一个预览-->
                       <div id="preview" class="spec-preview">
                           <img class="xzoom" xoriginal="/uploads/b1.png" src="/uploads/s1.png" width="100%">
                       </div>
                       <!--下方的缩略图-->
                       <div class="spec-scroll">
                           <a href="/uploads/b1.png"><img class="xzoom-gallery" src="/uploads/s1.png" width="60"></a>
                           <a href="/uploads/b2.png"><img class="xzoom-gallery" src="/uploads/s2.png" width="60"></a>
                           <a href="/uploads/b3.png"><img class="xzoom-gallery" src="/uploads/s3.png" width="60"></a>
                           <a href="/uploads/b1.png"><img class="xzoom-gallery" src="/uploads/s1.png" width="60"></a>
                           <a href="/uploads/b2.png"><img class="xzoom-gallery" src="/uploads/s2.png" width="60"></a>
                       </div>
                   </div>
               </div>
               <div class="fr itemInfo-wrap">
                   <div class="sku-name">
                       <h4>Apple iPhone 6s（A1700）64G玫瑰金色 移动通信电信4G手机</h4>
                   </div>
                   <div class="summary">
                       <div class="summary-wrap">
                           <div class="fl title"><i>价　　格</i></div>
                           <div class="fl price"><i>¥</i><em>5299.00</em></div>
                           <div class="fr remark"><i>累计评价</i><em>612188</em></div>
                       </div>
                   </div>
                   <div class="support">
                       <div class="summary-wrap">
                           <div class="fl title"><i>支　　持</i></div>
                           <div class="fl fix-width"><em class="t-gray">以旧换新，闲置手机回收 4G套餐超值抢 礼品购</em></div>
                       </div>
                   </div>
                   <div class="clearfix choose">
                       <div id="specification" class="summary-wrap clearfix">
                           <dl>
                               <dt class="fl title"><i>选择颜色</i></dt>
                               <dd>
                                   <a href="#" class="selected">金色</a>
                                   <a href="#">银色</a>
                                   <a href="#">黑色</a>
                               </dd>
                           </dl>
                           <dl>
                               <dt class="fl title"><i>内存容量</i></dt>
                               <dd>
                                   <a href="#" class="selected">16G</a>
                                   <a href="#">64G</a>
                                   <a href="#">128G</a>
                               </dd>
                           </dl>
                       </div>
   
                       <div class="summary-wrap">
                           <div class="controls">
                               <input autocomplete="off" type="text" value="1" minnum="1" class="itxt">
                               <a href="#" class="increment plus">+</a>
                               <a href="#" class="increment mins">-</a>
                           </div>
                           <a href="cart-add.html" class="sui-btn  btn-danger addshopcar">加入购物车</a>
                       </div>
                   </div>
               </div>
           </div>
           <!--product-detail-->
           <div class="clearfix product-detail">
               <div class="fl aside">
                   <ul class="sui-nav nav-tabs tab-wraped">
                       <li class="active">
                           <a href="#index" data-toggle="tab"><span>相关分类</span></a>
                       </li>
                       <li>
                           <a href="#profile" data-toggle="tab"><span>推荐品牌</span></a>
                       </li>
                   </ul>
                   <div class="tab-content tab-wraped">
                       <div id="index" class="tab-pane active">
                           <ul class="part-list unstyled">
                               <li>手机</li>
                               <li>手机壳</li>
                               <li>内存卡</li>
                               <li>Iphone配件</li>
                               <li>贴膜</li>
                               <li>手机耳机</li>
                               <li>移动电源</li>
                               <li>平板电脑</li>
                           </ul>
                           <ul class="goods-list unstyled">
                               <li>
                                   <div class="p-img"><img src="/uploads/mobile.png"></div>
                                   <div class="attr"><em>Apple苹果iPhone 6s (A1699)</em></div>
                                   <div class="price"><strong>￥6888</strong></div>
                                   <div class="operate"><a href="#" class="sui-btn btn-bordered">加入购物车</a></div>
                               </li>
                               <li>
                                   <div class="p-img"><img src="/uploads/mobile.png"></div>
                                   <div class="attr"><em>Apple苹果iPhone 6s (A1699)</em></div>
                                   <div class="price"><strong>￥6888</strong></div>
                                   <div class="operate"><a href="#" class="sui-btn btn-bordered">加入购物车</a></div>
                               </li>
                               <li>
                                   <div class="p-img"><img src="/uploads/mobile.png"></div>
                                   <div class="attr"><em>Apple苹果iPhone 6s (A1699)</em></div>
                                   <div class="price"><strong>￥6888</strong></div>
                                   <div class="operate"><a href="#" class="sui-btn btn-bordered">加入购物车</a></div>
                               </li>
                           </ul>
                       </div>
                       <div id="profile" class="tab-pane">
                           <p>推荐品牌</p>
                       </div>
                   </div>
               </div>
               <div class="fr detail">
                   <ul class="sui-nav nav-tabs tab-wraped">
                       <li class="active"><a href="#one" data-toggle="tab"><span>商品介绍</span></a></li>
                       <li><a href="#two" data-toggle="tab"><span>规格与包装</span></a></li>
                       <li><a href="#three" data-toggle="tab"><span>售后保障</span></a></li>
                       <li><a href="#four" data-toggle="tab"><span>商品评价</span></a></li>
                   </ul>
                   <div class="tab-content tab-wraped">
                       <div id="one" class="tab-pane active">
                           <ul class="goods-intro unstyled">
                               <li>分辨率：1920*1080(FHD)</li>
                               <li>后置摄像头：1200万像素</li>
                               <li>前置摄像头：500万像素</li>
                               <li>核 数：其他</li>
                               <li>频 率：以官网信息为准</li>
                               <li>品牌： Apple</li>
                               <li>商品名称：APPLEiPhone 6s Plus</li>
                               <li>商品编号：1861098</li>
                               <li>商品毛重：0.51kg</li>
                               <li>商品产地：中国大陆</li>
                               <li>热点：指纹识别，Apple Pay，金属机身，拍照神器</li>
                               <li>系统：苹果（IOS）</li>
                               <li>像素：1000-1600万</li>
                               <li>机身内存：64GB</li>
                           </ul>
                           <div class="intro-detail">
                               <img src="/uploads/intro01.png">
                               <img src="/uploads/intro02.png">
                               <img src="/uploads/intro03.png">
                           </div>
                       </div>
                       <div id="two" class="tab-pane">
                           <p>规格与包装</p>
                       </div>
                       <div id="three" class="tab-pane">
                           <p>售后保障</p>
                       </div>
                       <div id="four" class="tab-pane">
                           <div class="comment">
                               <div class="com-tit">商品评价</div>
                               <div class="com-percent">好评率<span class="percent">96%</span></div>
                               <div class="com-tab-type">
                                   <ul class="type">
                                       <li class="current"><a href="#">全部评价(123456)</a></li>
                                       <li><a href="#">晒图(500)</a></li>
                                       <li><a href="#">追评(500)</a></li>
                                       <li><a href="#">好评(500)</a></li>
                                       <li><a href="#">中评(500)</a></li>
                                       <li><a href="#">差评(500)</a></li>
                                   </ul>
                                   <div class="content">
                                       <div class="com-item">
                                           <div class="user-column">
                                               <div class="username">
                                                   <img src="/uploads/photo.jpg">用户****1</div>
                                               <div class="usernum">品享值258698</div>
                                           </div>
                                           <div class="user-info">
                                               <div class="stars star4"></div>
                                               <p>手机还不错，可以的可以的</p>
                                               <div class="guige">
                                                   <ul class="mini">
                                                       <li>玫瑰金</li>
                                                       <li>标配版</li>
                                                       <li>2017-11-02 13:23</li>
                                                   </ul>
                                                   <div class="operate">
                                                       <span id="collect"><i class="sui-icon icon-tb-like"></i> 325</span>
                                                       <span id="comment"><i class="sui-icon icon-tb-wang"></i> 256</span>
                                                   </div>
                                                   <div class="clearfix"></div>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>
   {{/block}}
   ```

### 09 商品详情-渲染需求分析

1. 面包屑
2. 商品基本信息
3. 商品图片
4. 商品产品介绍
5. 左侧相关商品列表

```js
/**需求
 * 1.面包屑导航 渲染
 * 2.商品基本信息 渲染
 * 3.商品图片 渲染
 * 4.商品简介
 * 5.相关商品列表(猜你喜欢) 渲染
 */
/**接口products/:id?include=introduce,category,pictures */
/**同时获取商品详情的数据和猜你喜欢的数据 */
```

### 10 商品详情-数据准备

`product.js`

```js
// 获取商品详情根据id获取
exports.getProductById = (id) => {
    return axios.get(`products/${id}?include=introduce,category,pictures`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

详情页的猜你喜欢是5条数据，可以给猜你喜欢的函数传参limit

`item.js`

```js
// 商品详情页相关路由函数
const productModel = require('../models/product')
exports.index = (req, res, next) => {
    /**需求
     * 1.面包屑导航 渲染
     * 2.商品基本信息 渲染
     * 3.商品图片 渲染
     * 4.商品简介
     * 5.相关商品列表(猜你喜欢) 渲染
     */
    /**接口products/:id?include=introduce,category,pictures */
    /**同时获取商品详情的数据和猜你喜欢的数据 */
    const id = req.params.id
    Promise.all([productModel.getProductById(id), productModel.getLikeProducts(5)])
        .then(result => {
            res.json(result)
        }).catch(err => next(err))
    // res.render('item.art')
}
```

### 11 商品详情-渲染面包屑

`item.js`

```js
// 商品详情数据
res.locals.product = result[0]
// 相关商品数据
res.locals.other = result[1]
```

渲染

`item.art`

```html
<div class="crumb-wrap">
    <ul class="sui-breadcrumb">
        <li><a href="/list/{{product.category.parent.id}}">{{product.category.parent.name}}</a></li>
        <li><a href="/list/{{product.category.parent.parent.id}}">{{product.category.parent.parent.name}}</a></li>
        <li><a href="/list/{{product.category.id}}">{{product.category.name}}</a></li>
        <li class="active">{{product.name}}</li>
    </ul>
</div>
```



### 12 商品详情-渲染xzoom插件结构

`item.art`

```html
<div class="fl preview-wrap">
    <!--放大镜效果-->
    <div class="zoom">
        <!--默认第一个预览-->
        <div id="preview" class="spec-preview">
            <img class="xzoom" xoriginal="{{product.pictures[0].large}}" src="{{product.pictures[0].middle}}" width="100%">
        </div>
        <!--下方的缩略图-->
        <div class="spec-scroll">
            {{each product.pictures}}
            <a href="{{$value.large}}"><img class="xzoom-gallery" src="{{$value.middle}}" width="60"></a>
            {{/each}}
        </div>
    </div>
</div>
```



### 13 商品详情-商品基本信息渲染

`item.art`

```html
<div class="sku-name">
    <h4>{{product.name}}</h4>
</div>


<div class="summary">
    <div class="summary-wrap">
        <div class="fl title"><i>价　　格</i></div>
        <div class="fl price"><i>¥</i><em>{{product.price}}</em></div>
        <div class="fr remark"><i>累计评价</i><em>612188</em></div>
    </div>
</div>


<div class="summary-wrap">
    <form action="/cart/add">
        <div class="controls">
            <input type="hidden" name="id" value="{{product.id}}">
            <!-- 使用H5输入类型 autofocus自动获取焦点 -->
            <input type="number" name="num" min="1" value="1" class="itxt" autofocus>
        </div>
        <!-- 加入购物车的时候，要把数量也传进去，用form -->
        <button class="sui-btn  btn-danger addshopcar">加入购物车</button>
    </form>
</div>
```



### 14 商品详情-相关商品列表&简介渲染

`item.art`

```html
<div class="intro-detail">
    <!-- 使用@原文输出 -->
    {{@ product.introduce}}
</div>


<ul class="goods-list unstyled">
    <!-- 遍历相关商品 -->
    {{each other}}
    <li>
        <div class="p-img"><img src="{{$value.thumbnail}}"></div>
        <div class="attr"><em>{{$value.name}}</em></div>
        <div class="price"><strong>￥{{$value.price}}</strong></div>
        <div class="operate"><a href="/cart/add?id={{$value.id}}" class="sui-btn btn-bordered">加入购物车</a></div>
    </li>
    {{/each}}
</ul>
```



### 15 加入购物车-路由规则设置

`controllers/cart.js`

```js
// 购物车相关路由业务函数
exports.addCart = (req, res, next) => {
    /**刷新页面的时候会重复提交，因为走一个路由的时候，进行了两个业务，所以这两个业务要分开
     * 1.加入购物车
     * 2.渲染加入的商品信息及加入的数量
     */
    // 1.加入购物车
    // res.send('ok')
    console.log('加入购物车');
    
    /**添加购物车的时候，先走这里，然后走success的路由，使用重定向 */
    // res.redirect('/cart/addCartSuccess')
    // 重定向的时候，应该把id和数量携带过来一起提交
    const id = req.query.id
    const num = req.query.num
    res.redirect(`/cart/addCartSuccess?id=${id}&num=${num}`)
}
exports.addCartSuccess = (req, res, next) => {
    // 2.渲染加入的商品信息及加入的数量(展示添加的商品)
    res.send('ok')
}
```

`router.js`

```js
const cartController = require('./controllers/cart')
// 购物车相关路由
router.get('/cart/add', cartController.addCart)
router.get('/cart/addCartSuccess', cartController.addCartSuccess)
```

这样，加入购物车的时候，刷新页面只会提交一次

### 16 加入购物车-分析（需要使用session来区分状态）

```js
/**购物车操作分为两种情况： 未登录  已登录
 * 未登录：购物车操作 存储在浏览器端，cookie更方便一些，只有cookie才能被node操作，localStorge和sessionStorge是通过前端js操作
 * 已登录：购物车操作 PHP服务器 mysql数据库存储
 * 怎么区分未登录和已登录状态 使用session，如果登录成功，用户的信息将会存在user这个字段中
 */
```

### 17 加入购物车-配置session步骤

express-mysql-session session数据持久化

`app.js`

```js
const config = require('./configs')
/**使用session的步骤 npm官网查询如何使用
 * 1.安装包 express-session express-mysql-session
 * 2.导包
 * 3.获取持久化构造函数
 * 4.连接mysql的配置项，我们统一把配置项写在config里面，config里面的mysql中
 * 5.初始化持久化对象
 * 6.使用session中间件
 */
// 2.导包
const session = require('express-session')
const mysqlSession = require('express-mysql-session')
// 3.获取持久化构造函数
const MySqlStore = mysqlSession(session)
// 5.初始化持久化对象
const sessionStore = new MySqlStore(config.mysql)
// 6.使用session中间件
app.use(session({
    key: 'PYGSID',//session id
    secret: 'PYG_secret',//加密字符
    store: sessionStore,//持久化对象
    resave: false,//重新保存session，当session有有效期的时候，会设置成true
    saveUninitialized: false//是否在服务器启动的时候初始化session对象，还是在使用session的时候，初始化session对象
}))
```

`config.js`

```js
/**3.连接数据库配置 */
exports.mysql = {
    host: 'localhost',
    port: 3306,
    user: 'root',
    password: 'yiran0325',
    database: 'newshop'
}
```



## day05

### 01 购物车-添加操作-思路分析

`cart.js`

```js
/**1.加入购物车 */
if (!req.session.user) {
    // 未登录
    /**a.存储cookie cookie的存储格式是键值对字符串，约定好键=pyg64_cart_info，值json字符串数组 */
    /**b.获取指定的cookie信息 cookie拿出来最好是对象，然后根据key获取，req.cookie需要一个中间件处理数据cookie-parser*/


} else {
    // 已登录
}
```

npm i cookie-parser，看github官网使用中间件

`aao.js`

```js
/**cookie解析中间件 */
const cookieParser = require('cookie-parser')
app.use(cookieParser())
```

```js
// 未登录
/**a.存储cookie cookie的存储格式是键值对字符串，约定好键=pyg64_cart_info，值json字符串数组[{id:10,num:1},{}...] */
/**b.获取指定的cookie信息 cookie拿出来最好是对象，然后根据key获取，req.cookie需要一个中间件处理数据cookie-parser*/
/**c. 获取指定数据req.cookie.pyg_cart_info这个是约定好的，可以理解成购物车的配置信息，把pyg_cart_info、cookie的有效期，有效期存多久是由产品决定的，当做购物车的配置信息*/
/**d. 获取到的数据是json格式的字符串数组，需要转换成真正的数组才好操作，才好对数组进行修改*/
/**e.json格式的字符串应该存商品的id，数量num
 * 添加商品  正常情况：直接添加就可以，特殊情况：如果遇见相同的商品，直接数量累加
 */
/**f. 修改完内存中的数组，把修改好的数组，存储到cookie中，更新cookie信息*/
/**g.重定向，添加成功展示页面 */
```



### 02 购物车-添加操作-在cookie添加

`config.js`

```js
/**4. 购物车相关配置*/
exports.cartCookie = {
    key: 'pyg_cart_info',
    // 过期时间，这里设置为一个月
    expires: 30 * 24 * 60 * 60 * 1000
}
```

`cart.js`

```js
const configs = require('../configs')
 if (!req.session.user) {
    const cartCookie = req.cookies[configs.cartCookie.key] || '[]' //给一个默认数据，否则转换报错
    const cartList = JSON.parse(cartCookie)
    // 判断当前的数据中有没有数据，根据id判断
    // 数组方法find，找到符合条件的元素，并返回该元素
    const item = cartList.find((item, i) => {
        item.id = id
    })
    if (item) {
        // 有相同的商品
        item.num = parseInt(item.num) + parseInt(num)
    } else {
        cartList.push({
            id,
            num
        })
    }
    // 更新cookie
    // req是获取cookie，res是设置cookie
    // express官网->API->response->res.cookie(name, value [, options])
    const expires = new Date(Date.now() + configs.cartCookie.expires)//Date.now()是1970年1月1日0分0秒到现在的时间戳，然后加上设置的有效期，得到cookie的失效时间
    res.cookie(configs.cartCookie.key, JSON.stringify(cartList), {
        expires
    })
} else {
    // 已登录
}
```

添加购物车后，可以在Application中看到cookie，value值可以通过`decodeURIComponent('%5B%7B%22id%22%3A%22701%22%2C%22num%22%3A%221%22%7D%5D')`得到`"[{"id":"701","num":"1"}]"`

再添加一件商品到购物车，可以得到两条数据`decodeURIComponent('%5B%7B%22id%22%3A%22278%22%2C%22num%22%3A%221%22%7D%2C%7B%22id%22%3A%22278%22%2C%22num%22%3A%221%22%7D%5D')` -> `"[{"id":"278","num":"1"},{"id":"278","num":"1"}]"`

### 03 购物车-添加操作-成功提示页面模板准备

`views/cart-add.art`

```html
{{extend './lauout/common.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-cart.css">
{{/block}}
{{block 'script'}}{{/block}}
{{block 'content'}}
<div class="success-cart">
    <div class="py-container ">
        <h3>
            <i class="sui-icon icon-pc-right"></i>商品已成功加入购物车！</h3>
        <div class="goods">
            <div class="left-good">
                <div class="left-pic">
                    <img src="/uploads/mobile.png">
                </div>
                <div class="right-info">
                    <p class="title">美的（Midea)电饭煲WFZ5099IH IH电磁加热 1250W大火力 钛金釜5L电饭锅</p>
                    <p class="attr">颜色：WFZ5099IH/5L钛金釜内胆 数量：1</p>
                </div>
            </div>
            <div class="right-gocart">
                <a href="item.html" class="sui-btn btn-xlarge">查看商品详情</a>
                <a href="cart.html" class="sui-btn btn-xlarge btn-danger ">去购物车结算 ></a>
            </div>
        </div>
    </div>
</div>

{{/block}}
```



### 04 购物车-添加操作-成功提示页面

`cart.js`

```js
exports.addCartSuccess = (req, res, next) => {
    // 2.渲染加入的商品信息及加入的数量(展示添加的商品)
    // res.send('ok')
    /**需要的数据id 名称 图片 数量，id和数量通过url可以拿到*/
    // 获取商品基本信息
    res.render('cart-add.art')
}
```

`product.js`

```js
// 获取商品基本信息根据id获取
exports.getProductBaseById = (id) => {
    return axios.get(`products/${id}`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`cart.js`

```js
const productModel = require('../models/product')


exports.addCartSuccess = (req, res, next) => {
    // 2.渲染加入的商品信息及加入的数量(展示添加的商品)
    // res.send('ok')
    /**需要的数据id 名称 图片 数量，id和数量通过url可以拿到*/
    // 获取商品基本信息
    const {
        id,
        num
    } = req.query
    productModel.getProductBaseById(id)
        .then(data => {
            // res.json(data)
            // 简化需要的数据
            res.locals.product = {
                id: data.id,
                name: data.name,
                thumbnail: data.thumbnail,
                num
            }
            // res.json(res.locals.product)
            res.render('cart-add.art')
        })
        .catch(err => next(err))
    // res.render('cart-add.art')

}
```

`cart-add.art`

```html
<div class="goods">
    <div class="left-good">
        <div class="left-pic">
            <img src="{{product.thumbnail}}">
        </div>
        <div class="right-info">
            <p class="title">{{product.name}}</p>
            <p class="attr">数量：{{product.num}}</p>
        </div>
    </div>
    <div class="right-gocart">
        <a href="/item/{{product.id}}" class="sui-btn btn-xlarge">查看商品详情</a>
        <a href="/cart" class="sui-btn btn-xlarge btn-danger ">去购物车结算 ></a>
    </div>
</div>
```



### 05 购物车-展示购物车页面-列表页-准备静态页面

点击去购物车结算，来到新的路由，展示购物车页面

`router.js`

```js
router.get('/cart', cartController.index)
router.get('/cart/list', cartController.list)
```

`cart.js`

```js
// 展示购物车页面
exports.index = (req, res, next) => {
    // 打算异步获取数据，
    // 返回页面的时候，数据以json格式的字符串返回，只展示一个空壳，购物车的列表数据在客户端以ajax请求动态获取数据，页面先展示给客户端，数据通过ajax来拿
    // 负责返回静态页面
    res.locals.user = req.session.user

    // res.send('ok')
    res.render('cart.art')
}
// 购物车列表数据以另外一个接口返回
exports.list=(req,res,next)=>{
    // 负责返回购物车数据。格式是json，这是一个数据接口
    res.json({})
}
```

`cart.html`

```html
{{extend './lauout/common.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-cart.css">
{{/block}}
{{block 'script'}}{{/block}}
{{block 'content'}}
<div class="py-container">
    <div class="allgoods">
        <br>
        <!-- 提示信息 -->
        {{if !user}}
        <div class="sui-msg msg-large msg-block msg-tips">
            <div class="msg-con"> 您还没有登录！登录后购物车的商品将保存到您账号中 <a href="/login" class="sui-btn btn-danger">立即登录</a></div>
            <s class="msg-icon"></s>
        </div>
        {{/if}}
        <div class="cart-main">
            <div class="yui3-g cart-th">
                <div class="yui3-u-1-24"><input type="checkbox" name="" id=""></div>
                <div class="yui3-u-12-24">商品</div>
                <div class="yui3-u-3-24">单价（元）</div>
                <div class="yui3-u-3-24">数量</div>
                <div class="yui3-u-4-24">小计（元）</div>
                <div class="yui3-u-1-24">操作</div>
            </div>
            <div class="cart-item-list">
                <div class="cart-body">
                    <div class="cart-list">
                        <ul class="goods-list yui3-g">
                            <li class="yui3-u-1-24"><input type="checkbox"></li>
                            <li class="yui3-u-12-24">
                                <div class="good-item">
                                    <div class="item-img">
                                        <img src="/uploads/mobile.png">
                                    </div>
                                    <div class="item-msg">
                                        <a href="">Apple Macbook Air 13.3英寸笔记本电脑 银色（Corei5）处理器/8GB内存</a>
                                    </div>
                                </div>
                            </li>

                            <li class="yui3-u-3-24">
                                <span class="price">￥8848.00</span>
                            </li>
                            <li class="yui3-u-3-24">
                                <a href="#" class="increment mins">-</a>
                                <input autocomplete="off" type="text" value="1" minnum="1" class="itxt">
                                <a href="#" class="increment plus">+</a>
                            </li>
                            <li class="yui3-u-4-24">
                                <span class="sum">￥8848.00</span>
                            </li>
                            <li class="yui3-u-1-24">
                                <a href="#none">删除</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="cart-tool">
            <div class="money-box">
                <div class="sumprice">
                    <span><strong>1</strong> 件商品</span><br>
                    <span><em>总价（不含运费）：</em><i class="summoney">¥16283.00</i></span>
                </div>
                <div class="sumbtn">
                    <a class="sum-btn" href="checkout.html">结算</a>
                </div>
            </div>
        </div>
    </div>
</div>

{{/block}}
```



### 06 购物车-列表页-准备列表数据

`cart.js`

```js
// 购物车列表数据以另外一个接口返回
exports.list = (req, res, next) => {
    // 负责返回购物车数据。格式是json，这是一个数据接口
    if (!req.session.user) {
        // 如果未登录从cookie中取数据，如果已登录，从服务器端获取数据
        // 未登录
        /**1. 获取cookie拿出字符串，转换成数组[{id:11,num:2},...] 不符合页面的要求，没有name,price等信息*/
        /**根据所有商品id获取 ，组织数组*/
        const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
        const cartList = JSON.parse(cartCookie)
        // console.log(cartList);

        // 注意：有多个商品，要拿多个商品的数据
        // Promise.all(Promise数组)
        // 根据cartList里面的数据，返回一个获取商品数据的Promise数组
        // 遍历数组map的结果会返回一个新的数组
        const promiseArr = cartList.map((item, i) =>
            productModel.getProductBaseById(item.id)
        )
        Promise.all(promiseArr)
            .then(results => {
                res.json({
                    code: 200,
                    // 拿到的结果再遍历，取出num，amount等信息
                    list: results.map((item, i) => ({
                        id: item.id,
                        name: item.name,
                        thumbnail: item.thumbnail,
                        price: item.price,
                        num: +cartList[i].num, //把num统一转成数字
                        amount: item.amount //库存
                    }))
                })
            }).catch(err => {
                res.json({
                    code: 500,
                    msg: '获取购物车信息失败'
                })
            })
        // res.json({})
    }

}
```



### 07 购物车-列表页-准备在前端使用artTemplate

`cart.art`

返回的数据在静态页面上获取

```html
{{block 'script'}}
<script type="text/template" id="list">
    <? for(var i=0;i<list.length;i++){ ?>
    <ul class="goods-list yui3-g">
        <li class="yui3-u-1-24"><input type="checkbox"></li>
        <li class="yui3-u-12-24">
            <div class="good-item">
                <div class="item-img">
                    <img src="/uploads/mobile.png">
                </div>
                <div class="item-msg">
                    <a href="">Apple Macbook Air 13.3英寸笔记本电脑 银色（Corei5）处理器/8GB内存</a>
                </div>
            </div>
        </li>

        <li class="yui3-u-3-24">
            <span class="price">￥8848.00</span>
        </li>
        <li class="yui3-u-3-24">
            <a href="#" class="increment mins">-</a>
            <input autocomplete="off" type="text" value="1" minnum="1" class="itxt">
            <a href="#" class="increment plus">+</a>
        </li>
        <li class="yui3-u-4-24">
            <span class="sum">￥8848.00</span>
        </li>
        <li class="yui3-u-1-24">
            <a href="#none">删除</a>
        </li>
    </ul>
    <? } ?>

</script>
<script src="/assets/js/template-web.js"></script>
<script>
    $(function(){
        // 修改模板引擎的解析规则
        // <% js语法 %>  =>  <? js语法 %?> 问号也是正则表达式的符号，需要转义
        template.defaults.rules[0].test = /<\?(#?)((?:==|=#|[=-])?)[ \t]*([\w\W]*?)[ \t]*(-?)\?>/;
        /** 1. 获取购物车数据，并渲染*/
        $.get(`/cart/list`,function(data){
            // console.log(data);
            /**2. 渲染，前端使用模板引擎渲染，*/
            // 2.1 准备数据 data
            // 2.2 准备模板 cart.art是后端模板，在响应客户端之前会解析
            // 2.3 前端模板是script标签，类型是text/template，指定ID
            // 2.4 调用模板函数，返回HTML格式的字符串
            var html=template('list',data)
            console.log(html);
            // 2.5 如果前后端同时使用art-template模板引擎，修改art-template解析语法
           
        })
    })
</script>
{{/block}}
```



### 08 购物车-列表页-模版渲染

`cart.art`

```js
<script type="text/template" id="list">
    <? for(var i = 0; i < list.length; i++){ ?>
        <? var item = list[i] ?>
    <ul class="goods-list yui3-g">
        <li class="yui3-u-1-24"><input type="checkbox"></li>
        <li class="yui3-u-12-24">
            <div class="good-item">
                <div class="item-img">
                    <a href="/item/<?=item.id?>"><img src="<?=item.thumbnail?>"></a>
                </div>
                <div class="item-msg">
                    <a href="/item/<?=item.id?>"><?=item.name?></a>
                </div>
            </div>
        </li>

        <li class="yui3-u-3-24">
            <span class="price">￥<?=item.price?></span>
        </li>
        <li class="yui3-u-3-24">
            <a href="javascript:;" class="increment mins">-</a>
            <input autocomplete="off" type="text" value="<?=item.num?>"  class="itxt">
            <a href="javascript:;" class="increment plus">+</a>
        </li>
        <li class="yui3-u-4-24">
            <!-- toFixed(2)显示两位小数 -->
            <span class="sum">￥<?=(item.num*item.price).toFixed(2)?></span>
        </li>
        <li class="yui3-u-1-24">
            <a href="javascript:;">删除</a>
        </li>
    </ul>
    <? } ?>

</script>
```



### 09 购物车-列表页-功能需求分析

```js
/**2. 单选功能*/
/**3. 全选*/
/**4. 修改数量，需要前后交互，调用接口*/
/**5. 删除，需要前后交互，调用接口*/
```



### 10 购物车-列表页-单选-计算总金额&总数

`cart.art 单选`

```js
/**2. 单选功能*/
// change，改变时触发
$('.cart-list').on('change','[type="checkbox"]',function () {
    //1.进行全选的判断
    // 被选中的和列表的长度作比较
    const checkedLen=$('.cart-list [type="checkbox"]:checked').length
    const listLen=$('.cart-list > ul').length

    $('.cart-th [type="checkbox"]').prop('checked',checkedLen===listLen)

    //2.计算总数量和总价格
    calc()
})




// 封装计算总金额和总数量
var calc = function(){
    // 1.获取全部选中的input  不包含头部
    var $checkedInputList=$('.cart-list [type="checkbox"]:checked')
    // 2.根据当前的选中的商品，找数量和单价，操作DOM比较麻烦，可以根据数据获取，在渲染的时候作数据缓存window.list，遍历
    // 3.一定需要知道商品的id  data-id
    // <!-- data-id="<?=item.id?>" 自定义属性 -->
    // <li class="yui3-u-1-24"><input type="checkbox" data-id="<?=item.id?>"></li>
    var count=0  //数量
    var total=0  //金额
    $checkedInputList.each(function (i,item) {
        var id = item.dataset.id//获取自定义属性
        // 单价和数量在每个商品中，如果遍历的list中的商品id==被选中的input里面的id,就取出
        var product=list.find((item,i)=>item.id==id)
        count+=product.num
        total+=product.num*product.price
    })
    // 4.计算 渲染
    $('strong').html(count)
    $('.summoney').html("￥"+total.toFixed(2))
}

```



### 11 购物车-列表页-全选功能

```js
/**3. 全选*/
$('.cart-th').on('change','[type="checkbox"]',function () {
    $('.cart-list [type="checkbox"]').prop('checked',$(this).prop('checked'))
    calc()
})
```



### 12 购物车-列表页-定义修改数量的路由规则

修改需要传id和num

`app.js`

```js
// 处理post提交数据中间件
app.use(express.json())
app.use(express.urlencoded({
    extended: false
}))
```

`router.js`

```js
router.post('/cart/edit', cartController.edit)
```

`cart.js`

```js

// 修改购物车商品数量的接口，返回json
exports.edit = (req, res, next) => {
    if (!req.session.user) {
        // 修改需要传id和num
        // 约定传参： id num 请求方式post
        const {
            id,
            num
        } = req.body
        res.json(req.body)
    } else {
        // 已登录
    }
}
```

在控制台测试接口`$.post('/cart/edit',{id:111,num:2},function(data){console.log(data)})`

### 13 购物车-列表页-定义修改数量接口完毕

`cart.js`

```js

// 修改购物车商品数量的接口，返回json
exports.edit = (req, res, next) => {
    if (!req.session.user) {
        // 修改需要传id和num
        // 约定传参： id num 请求方式post
        const {
            id,
            num
        } = req.body
        // 1.获取购物车数据，从cookie中拿
        const cartCookie = req.cookies[configs.cartCookie.key] || '[]' //给一个默认数据，否则转换报错
        const cartList = JSON.parse(cartCookie)
        // 2.修改
        const product = cartList.find((item, i) => item.id == id)
        product.num = +num //商品的num=传递过来的num，转换成数字类型传进去
        // 3.存起来
        const expires = new Date(Date.now() + configs.cartCookie.expires)
        res.cookie(configs.cartCookie.key, JSON.stringify(cartList), {
            expires
        })
        // 成功
        res.json({
            code: 200,
            msg: '修改成功'
        })
    } else {
        // 已登录
    }

}
```



### 14 购物车-列表页-前端加和减的交互效果

`cart.art`

```js
给input设置最大值
<input readonly autocomplete="off" type="text" value="<?=item.num?>" data-max="<?=item.amount?>" class="itxt">

/**4. 修改数量，需要前后交互，调用接口*/
    // 不能直接给加减按钮绑定事件，因为模板是动态生成的，
    $('.cart-list').on('click', '.increment', function () {
        // console.log(this.className);
        // 获取当前的value值
        var $input = $(this).siblings('input')
        var num = $input.val()
        var max = $input.data('max')
        if ($(this).hasClass('mins')) {
            // 减
            if (num < 2) return false
            num--
        } else {
            // 加，如果大于库存，就不加了
            if (num >= max) return false
            num++
        }
        // 测试效果
        $input.val(num)
    })
```



### 15 购物车-列表页-修改商品数量

`cart.art`

```js
发请求，需要id，给input设置id，并获取id
<input readonly autocomplete="off" type="text" value="<?=item.num?>" data-id="<?=item.id?>" data-max="<?=item.amount?>" class="itxt">
    

$.post('/cart/edit', {
    id,
    num
}, (data) => {
    if (data.code === 200) {
        // 操作成功
        // 1.修改数量
        $input.val(num)
        // 2.修改小计
        // 现在修改的商品
        var product = list.find((item, i) => item.id == id)
        product.num = num //把现在修改的商品的num改成改了之后的num
        // $(this)这个this是ajax对象，我们需要的是上一个this才是加减按钮，所以这里function(data){}改成箭头函数
        $(this).parent().next().find('span').html('￥' + (product.num * product.price).toFixed(2))
        // 3.修改总数量和总价格
        calc()
    } else {
        // 不成功
        alert(data.msg)
    }
})
```



## day06 

### 01 物车-购物车列表-删除接口

`router.js`

```js
router.post('/cart/remove', cartController.remove)
```

`cart.js`

```js
// 删除购物车商品接口，返回json
exports.remove = (req, res, next) => {
    // 从cookie中删除，根据id删除
    const id = req.body.id //商品id
    if (!req.session.user) {
        // 未登录
        // 操作cookie
        // 1.获取
        const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
        const cartList = JSON.parse(cartCookie)
        // 2.删除
        // splice(index,1)删除数组中某一项
        const index = cartList.findIndex((item, i) => item.id == id)
        cartList.splice(index, 1)

        // 3.存储，重新计算当前的有效期
        const expires = new Date(Date.now() + configs.cartCookie.expires)
        res.cookie(configs.cartCookie.key, JSON.stringify(cartList), {
            expires
        })
        // 响应客户端
        res.json({
            code: 200,
            msg: '删除成功'
        })

    } else {
        // 已登录
    }
}
```



### 02 购物车-购物车列表-前端删除完成

`cart.art`

```js
<a href="javascript:;" data-id="<?=item.id?>" class="btn_remove">删除</a>


/**5. 删除，需要前后交互，调用接口*/
$('.cart-list').on('click','.btn_remove',function () {
    // 删除需要调接口，需要id
    const id=this.dataset.id
    $.post(`/cart/remove`,{id}, (data)=> {
        if(data.code===200){
            // 操作成功
            // 1.更新列表
            // 删除所对应的行，即ul
            $(this).parents('.goods-list').remove()
            // 2.更新总数量和总价格
            calc()
        }else{
            alert(data.msg)
        }
    })
})
```



### 03 登录模块-路由规则设置

登录页面，点击登录按钮，需要提交表单信息，所以登录页面应该有两个路由，一个展示登录页面get请求，一个提交表单信息post请求

`router.js`

```js
const usersController = require('./controllers/users')
// 登录相关路由
router.get('/login', usersController.login)
router.post('/login', usersController.loginLogic)
```

`controllers/users.js`

```js
// 定义用户相关的路由函数
exports.login = (req, res, next) => {
    res.send('ok')
}
// 登录逻辑,表单提交
exports.loginLogic = (req, res, next) => {
    res.send('ok')
}
```



### 04 登录模块-登录成功后的回跳逻辑

![1551781719199](C:\Users\初见\AppData\Roaming\Typora\typora-user-images\1551781719199.png)

### 05 登录模块-登录页面准备

`cart.art`

```html
<!-- 这样点击登录的时候，可以带上返回的页面地址 -->
<div class="msg-con"> 您还没有登录！登录后购物车的商品将保存到您账号中 <a href="/login?returnUrl=/cart" class="sui-btn btn-danger">立即登录</a></div>
```

`users.js`返回`res.render('login.art')`

`views/login.art`基于basic模板

```html
{{extend './lauout/basic.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-account.css">
{{/block}}
{{block 'script'}}
<script src="/assets/js/sui.tab.js"></script>
{{/block}}
{{block 'body'}}
<div class="login-box">
    <!--head-->
    <div class="py-container logoArea"><a href="/" class="logo"></a></div>
    <!--loginArea-->
    <div class="loginArea">
        <div class="py-container login">
            <div class="loginform">
                <ul class="sui-nav nav-tabs tab-wraped">
                    <li><a href="#index" data-toggle="tab">扫描登录</a></li>
                    <li class="active"><a href="#profile" data-toggle="tab">账户登录</a></li>
                </ul>
                <div class="tab-content tab-wraped">
                    <div id="index" class="tab-pane">
                        <p>啦啦啦</p>
                    </div>
                    <div id="profile" class="tab-pane active">
                        <form class="sui-form" autocomplete="off">
                            <div class="input-prepend">
                                <span class="add-on loginname"></span>
                                <input type="text" class="span2 input-xfat" placeholder="用户名/邮箱">
                            </div>
                            <div class="input-prepend">
                                <span class="add-on loginpwd"></span>
                                <input type="password" class="span2 input-xfat" placeholder="请输入密码">
                            </div>
                            <div class="input-prepend">
                                <span class="add-on logincaptcha"></span>
                                <input type="text" name="captcha" class="span2 input-xfat" placeholder="请输入验证码" style="width: 150px">
                            </div>
                            <div class="setting">
                                <label class="checkbox inline"><input name="m1" type="checkbox"> 自动登录</label>
                                <span class="forget">忘记密码？</span>
                            </div>
                            <div class="logined">
                                <a class="sui-btn btn-block btn-xlarge btn-danger" href="member.html">登&nbsp;&nbsp;录</a>
                            </div>
                        </form>
                        <a href="register.html">立即注册</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--foot-->
    <div class="py-container copyright">
        <ul>
            <li>关于我们</li>
            <li>联系我们</li>
            <li>联系客服</li>
            <li>商家入驻</li>
            <li>营销中心</li>
            <li>手机品优购</li>
            <li>销售联盟</li>
            <li>品优购社区</li>
        </ul>
        <div class="address">地址：北京市昌平区建材城西路金燕龙办公楼一层 邮编：100096 电话：400-618-4000 传真：010-82935100</div>
        <div class="beian">京ICP备08001421号京公网安备110108007702
        </div>
    </div>
</div>
{{/block}}
```



### 06 登录模块-svg-captcha插件使用(验证码)

svg-captcha包可以生成svg格式的图片

安装npm install  svg-captcha

`user.js`

```js
// 定义用户相关的路由函数
const svgCaptcha = require('svg-captcha')
// 页面展示
exports.login = (req, res, next) => {
    // res.send('ok')
    // 1.通过svg-captcha的包 生成svg格式的图片，svg标签HTML
    const captcha = svgCaptcha.createMathExpr({width:120,height:30,fontSize:30});
    // 2.captcha {data: svg格式的图片, text: 图片的内容或公式的结果} 图片的内容可能是字符，也可能是运算公式
    res.locals.svg = captcha.data
    res.render('login.art')
}
```

`login.art`

```html
{{@svg}}
```



### 07 登录模块-登录逻辑-实现步骤

```js
/** 登录逻辑 */
/**需求
 * 1.保证表单数据的完整性 校验
 * 2.验证码校验
 * 3.用户名和密码校验 调接口
 * 4.如果选中了自动登录，准备自动登录的数据
 * 5.合并购物车(浏览器中的购物车信息，合并到登陆后的账户下，清空浏览器中的购物车)
 * 6.补充：错误提示统一处理
 */
```



### 08 登录模块-登录逻辑-错误捕获

`login.art`给表单设置action和method，表单元素设置name属性，根据接口中的`POST users/login`设置

```html
 <div id="profile" class="tab-pane active">
    <form class="sui-form" action="/login" method="post" autocomplete="off">
        <div class="input-prepend">
            <span class="add-on loginname"></span>
            <input name="username" type="text" class="span2 input-xfat" placeholder="用户名/邮箱">
        </div>
        <div class="input-prepend">
            <span class="add-on loginpwd"></span>
            <input name="password" type="password" class="span2 input-xfat" placeholder="请输入密码">
        </div>
        <div class="input-prepend">
            <span class="add-on logincaptcha"></span>
            <input type="text" name="captcha" class="span2 input-xfat" placeholder="请输入验证码" style="width: 150px">
            {{@svg}}
        </div>
        <div class="setting">
            <label class="checkbox inline"><input name="auto" value="1" type="checkbox"> 自动登录</label>
            <span class="forget">忘记密码？</span>
        </div>
        <div class="logined">
            <button class="sui-btn btn-block btn-xlarge btn-danger">登&nbsp;&nbsp;录</button>
        </div>
    </form>
    <a href="/register">立即注册</a>
</div>
```

`users.js`

````js
const createError = require('http-errors')

// 登录逻辑,表单提交
exports.loginLogic = (req, res, next) => {
    const {
        username,
        password,
        captcha,
        auto
    } = req.body
    // 如果表单输入不完整，需要处理错误，这里不能进入错误统一处理中间件，因为错误统一处理中间件是返回404或500页面，这里不需要，所以要单独处理错误，这里使用Promise，resolve里面的代码一定是成功之后才会执行，如果错误，会被catch捕获
    Promise.resolve().then(() => {
        // 1.保证表单数据的完整性 校验
        // 如果信息不完整
        // 直接抛出异常，创建一个错误，状态码是456，随便写的，为了区分是程序运行的错误还是自己创建的错误
        if (!(username && password && captcha)) throw createError(456, '表单必须输入完整')
        //2.验证码校验
        //3.用户名和密码校验 调接口
        //4.如果选中了自动登录，准备自动登录的数据
        //5.合并购物车(浏览器中的购物车信息，合并到登陆后的账户下，清空浏览器中的购物车)
    }).catch(err => {
        //6.补充：错误提示统一处理
        res.send(err.message)
    })
    // res.send('ok')
}
````



### 09 登录模块-登录逻辑-错误处理

`users.js`

```js
.catch(err => {
    // 6. 补充：错误提示统一处理
    // 6.1 在页面展示错误提示信息
    // 6.2 有两种提示信息：自己创建的信息，程序运行时的错误信息 ,456状态码是我们自己创建的错误
    if (err.status === 456) {
        res.locals.msg = err.message
    } else {
        res.locals.msg = '登录失败'
    }
    // 6.3 重新生成验证码
    const captcha = svgCaptcha.createMathExpr({
        width: 120,
        height: 30,
        fontSize: 30
    });
    res.locals.svg = captcha.data
    // 如果有错误，返回登录页面
    res.render('login.art')
})
```

`login.art` 在页面展示错误信息

```html
<!-- 展示错误信息 -->
{{if msg}}
<div class="sui-msg msg-error" style="margin-left: 20px">
    <div class="msg-con">{{msg}}</div>
    <s class="msg-icon"></s>
</div>
{{/if}}
```



### 10 登录模块-登录逻辑-验证码校验

![1551798100145](C:\Users\初见\AppData\Roaming\Typora\typora-user-images\1551798100145.png)

要在生成svg的时候，保存text

`req.session.text = captcha.text//记录结果，下次校验`

出现错误的时候，更新text     `req.session.text = captcha.text//记录结果，下次校验`

````js
//2.验证码校验
// 用户提交的svg和上一次创建的svg(在返回登录页面的时候创建的svg)作比较
if (captcha !== req.session.text) throw createError(456, '验证码错误')
````



### 11 登录模块-登录逻辑-验证用户名和密码

校验用户名和密码需要调接口，操作数据，在models新建users.js

`models/users.js`

```js
// 用户相关接口操作
const axios = require('./axiosInstance')
exports.login = (username, password) => {
    return axios.post(`users/login`, {
            username,
            password
        })
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`controller/users.js`

```js
const usersModel = require('../models/users')

//3.用户名和密码校验 调接口
return usersModel.login(username, password) //在Promise中return了一个Promise对象，在下一个.then()中处理成功的回调，所有的错误都会走catch()

.then(data => {
    //4.如果选中了自动登录，准备自动登录的数据
    //5.合并购物车(浏览器中的购物车信息，合并到登陆后的账户下，清空浏览器中的购物车)

})
// 随便输入用户名和密码，保证验证码正确，此时提示登录失败，但是错误原因不明确，打印下错误对象

.then(user => {
    // console.log(user);//user是用户信息
    if (!user) throw createError(456, '登录失败')
    // 登陆成功
    req.session.user = user
    res.json(user)
    //4.如果选中了自动登录，准备自动登录的数据
    //5.合并购物车(浏览器中的购物车信息，合并到登陆后的账户下，清空浏览器中的购物车)

})

// console.log(err);
// console.log(err.response.data.message)
if (err.response) {
    res.locals.msg = err.response.data.message || '登录失败'
} else {
    res.locals.msg = '登录失败'
}
```



### 12 登录模块-登录逻辑-分析自动登录需要保存的信息是啥

![1551835881564](C:\Users\初见\AppData\Roaming\Typora\typora-user-images\1551835881564.png)

### 13 登录模块-登录逻辑-保存自动登录所需要的数据

`configs.js`

```js
/**5. 自动登录相关配置信息 */
exports.loginCookie = {
    key: 'pyg_user_info',
    // 过期时间，这里设置为7天
    expires: 7 * 24 * 60 * 60 * 1000
}
```

`controllers/users.js`

```js
const configs = require('../configs')

// 判断auto的值是否为1， 是否不存在
if (auto) {
    //4.如果选中了自动登录，准备自动登录的数据
    // 保存在cookie中，得约定好字段名，值，过期时间，在configs中配置
    // 把cookie存储到客户端，但是不能让客户端操作cookie，express官网-API-response-res.cookie()=>httpOnly:true
    res.cookies(configs.loginCookie.key,JSON.stringify({id:user.id,pwd:user.password}),{expires:new Date(Date.now()+configs.loginCookie.expires),httpOnly:true})
}
```



### 14 登录模块-登录逻辑-合并购物车

`nodels/cart.js`

```js
// 购物车相关的接口操作
const axios = require('./axiosInstance')
exports.add = (userId, id, num) => {
    return axios.post(`users/${userId}/cart`, {
            id,
            amount: num
        })
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`cpntrollers/users.js`

```js
const cartModel = require('../models/cart')

//5.合并购物车(浏览器中的购物车信息，合并到登陆后的账户下，清空浏览器中的购物车)
// 5.1获取客户端存储的购物车信息
const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
const cartList = JSON.parse(cartCookie)
// 5.2会有若干条商品，分别添加到账户下
// 接口文档POST users/:id/cart
// 需要的参数：用户id，商品id和商品数量，要做这件事必须有个调接口的方法models/cart.js
// cartModel.add()如果有十件商品，需要调十次接口，可以让这些若干次的添加，并行执行，所以这里生成一个Promise数组
const PromiseArr = cartList.map((item, i) => cartModel.add(user.id, item.id, item.num))
return Promise.all(PromiseArr)
})
.then(results => {
// 合并成功
// 5.3如果全部合并成功,清除客户端的购物车信息
// 清除cookie
res.clearCookie(configs.cartCookie.key)
})
```



### 15 登录模块-登录逻辑-回跳地址处理

```js
// 登录成功，业务完成，响应客户端
// 如果没有来源，响应个人中心首页，如果有来源，从哪里来，回哪里去
// 需要获取returnUrl，但是业务场景没有这个数据，在post提交的时候，没有提交returnUrl，可以在提交的时候，传递一个，隐藏 的input->login.art
```

`login.art`

```html
<input type="hidden" name="returnUrl" value="{{returnUrl}}">
```

在展示登录页的时候，有returnUrl，可以在展示登录页的时候，记录下来

`cpntrollers/users.js`

```js
login中
// 需要回跳的地址，记录下回跳的地址，传递到模板中的form表单，在post的时候，才能拿到回跳地址
res.locals.returnUrl = req.query.returnUrl||'/member'//member个人中心首页

loginLogic中
// 登录成功，业务完成，响应客户端
// 如果没有来源，响应个人中心首页，如果有来源，从哪里来，回哪里去
// 需要获取returnUrl，但是业务场景没有这个数据，在post提交的时候，没有提交returnUrl，可以在提交的时候，传递一个，隐藏 的input->login.art
res.redirect(req.body.returnUrl || '/member')


.carch中
// 如果登录失败，又会渲染login，需要再次携带returnUrl
res.locals.returnUrl = req.body.returnUrl||'/member'//member个人中心首页
```

把数据提交到服务器上了，现在是登录状态，所以回跳到购物车的时候，不显示内容

### 16 购物车-登录状态-获取列表信息

`models/cart.js`

```js
// 登录状态下的列表
exports.list = (userId) => {
    // GET users/:id/cart 
    return axios.get(`users/${userId}/cart`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`controllers/cart.js`

```js
exports.list中

else {
    // 已登录
    // 获取账号下的购物车信息
    cartModel.list(req.session.user.id)
        .then(data => {
            res.json({
                code: 200,
                // 直接的data数据不符合我们的要求，我们要的数量是num,后台返回的是amount，
                list: data.map((item, i) => ({
                    id: item.id,
                    name: item.name,
                    thumbnail: item.thumbnail,
                    price: item.price,
                    num: item.amount,
                    amount: 100 //库存
                }))
            })
        }).catch(err => {
            res.json({
                code: 500,
                msg: '获取购物车信息失败'
            })
        })
}
```



### 17 购物车-登录状态-添加购物车

`controllers/cart.js`

```js
exports.addCart

else {
    // 已登录
    // 登录状态下的添加购物车
    cartModel.add(req.session.user.id, id, num)
        .then(data => {
            // 添加成功
            res.redirect(`/cart/addCartSuccess?id=${id}&num=${num}`)
        })
        .catch(err => next(err))
}
```



### 18 购物车-登录状态-修改&删除操作完成

`models/cart.js`

```js
// 修改
exports.edit = (userId, id, num) => {
    // PATCH users/:id/cart/:cart_id
    return axios.patch(`users/${userId}/cart/${id}`, {
            amount: num
        })
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}


// 删除
exports.remove = (userId, id) => {
    // DEL users/:id/cart/:cart_id
    return axios.delete(`users/${userId}/cart/${id}`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`controllers/cart.js`

```js
exports.edit
else {
    // 已登录
    // 登录状态下修改购物车数量
    cartModel.edit(req.session.user.id, id, num)
        .then(data => {
            res.json({
                code: 200,
                msg: '修改成功'
            })
        })
        .catch(err => {
            res.json({
                code: 500,
                msg: '修改失败'
            })

        })
}

exports.remove
else {
    // 已登录
    // 登录状态下删除购物车数量
    cartModel.remove(req.session.user.id, id)
        .then(data => {
            res.json({
                code: 200,
                msg: '删除成功'
            })
        })
        .catch(err => {
            res.json({
                code: 500,
                msg: '删除失败'
            })

        })
}
```



### 19 订单模块-路由规则约定

点计算，会生成一个订单页面，

`cart.art`

````html
<a class="sum-btn" href="/checkout">结算</a>
````

`router.js`

```js
const orderController = require('./controllers/order')
// 订单相关
router.get('/checkout', orderController.checkout) //结算，生成订单

```

`controllers/order.js`

```js
// 定义订单相关路由函数
exports.checkout = (req, res, next) => {
    res.send('ok')
}
```



### 20 订单模块-登录拦截功能

`middlewares.js`

```js
// 定义登录拦截中间件
exports.checkLogin = (req, res, next) => {
    // 登录拦截，很多地方都要登录拦截，可以定义一个登录拦截中间件
    if (!req.session.user) {
        // 如果没有登录，则重定向到登录页面，携带当前的url后面好回跳，url中如果有参数，最好用url编码转码
        return res.redirect('/login?returnUrl=' + encodeURIComponent(req.url))
    }
    next()
}
```

`routers.js`

```js
const middlewares = require('./middlewares')

// 订单相关
router.get('/checkout', middlewares.checkLogin, orderController.checkout) //结算,这也是加中间件的方法，执行顺序是按写的顺序执行
```

测试未登录情况下会拦截，点结算来到登录页面



## day07

### 01 完善头部信息-链接内容

登录之后，网页显示用户名和退出登录

`controllers/cart.js`中展示页面的时候，存了用户信息`res.locals.user = req.session.user`这个是很多页面都会用到的，可以放在中间件middlewares.js的global中

`header.art`

```html
<ul class="fl">
    <li class="f-item">品优购欢迎您！</li>
    <li class="f-item">
        {{if !user}}
        <a href="/login">请登录</a>
        <a href="/register">免费注册</a>
        {{else}}
        <a href="/member">{{user.username}}</a>
        <a href="/logout">退出登录</a>
        {{/if}}
    </li>
</ul>
```

`controllers/users.js`退出登录

```js
// 退出登录
exports.logout = (req, res, next) => {
    // 删除session
    delete req.session.user
    res.redirect('/login')
}
```

`router.js`

```js
router.get('/logout', usersController.logout)
```



### 02 完善头部信息-定义头部购物车信息中间件

头部的购物车信息每个页面都有，可以定义一个中间件

`middlewares.js`

```js
// 定义一个头部购物车信息中间件
exports.headCart = (req, res, next) => {
    // 获取网页头部购物车需要的数据

    next()
}
```

在`app.js`中使用

```js
app.use(middlewares.global, middlewares.headCart)
```



### 03 完善头部信息-头部购物车信息完成

`middlewares.js`

```js

// 定义一个头部购物车信息中间件
exports.headCart = (req, res, next) => {
    // 获取网页头部购物车需要的数据
    // 需要商品的总数量 和 商品的名称列表数组
    if (!req.session.user) {
        // cookie购物车
        const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
        const cartList = JSON.parse(cartCookie)
        // reduce()数组的API，计算总和
        // arr.reduce((prev, item) => prev + item, 0)
        // prev是上次的返回结果，0是初始的prev，item是当前遍历的元素
        const cartNum = cartList.reduce((prev, item) => prev + parseInt(item.num), 0)
        // cartList存储的是商品的id，并没有商品的名称
        // 商品名称的数据得去取，所有的都要取
        const promiseArr = cartList.map((item, i) => productModel.getProductBaseById(item.id))
        Promise.all(promiseArr)
            .then(results => {
                // results是商品列表
                res.locals.headCart = {
                    cartNum,
                    cartList: results.map((item, i) => item.name)
                }
                next()
            }).catch(err => next(err))


    } else {
        // 服务器端的购物车
        // 登录了通过购物车里面的数据去拿
        cartModel.list(req.session.user.id)
            .then(data => {

                res.locals.headCart = {
                    cartNum: data.reduce((prev, item) => prev + parseInt(item.amount), 0),
                    cartList: data.map((item, i) => item.name)
                }
                next()
            }).catch(err => next(err))
    }
    next()
}
```

`header.art`

```html
 <div class="show-shopcar">
    <span class="car"></span>
    <a class="sui-btn btn-default btn-xlarge" href="/cart">
        <span>我的购物车</span>
        <i class="shopnum">{{headCart.cartNum}}</i>
    </a>
    <div class="clearfix shopcarlist">
        <ul>
            {{each headCart.cartList}}
            <li>{{$value}}</li>
            {{/each}}
        </ul>
    </div>
</div>
```

测试登陆状态下和未登录状态下的加入购物车操作

在修改数量(加和减)和删除操作的时候也需要更新头部购物车的数量和名称列表

`cart.art`

```js
// 修改数量 
// 4.修改头部购物车商品数量
$('.shopnum').html(list.reduce((prev,item)=>prev+parseInt(item.num),0))

// 删除操作
// 补充list数据操作
list.splice(list.findIndex((item,i)=>item.id==id),1)
$('.shopnum').html(list.reduce((prev,item)=>prev+parseInt(item.num),0))
//  修改头部列表
$('.shopcarlist ul').html(list.reduce((prev,item)=>prev+`<li>${item.name}</li>`,''))
```



### 04 支付-结算-路由规则约定

`order.js`

```js
// 生成订单
exports.addOrder = (req, res, next) => {
  // 生成订单
  res.redirect('checkout')

}
```

`router.js`

```js
// 订单相关
router.get('/checkout', middlewares.checkLogin, orderController.checkout) //结算页面,这也是加中间件的方法，执行顺序是按写的顺序执行
router.get('/order/add', middlewares.checkLogin, orderController.addOrder) //生成订单,这也是加中间件的方法，执行顺序是按写的顺序执行
```



### 05 支付-结算-多件商品数据传参

生成订单需要调接口，看接口文档，POST orders ->  https://ns-api.uieee.com/v1/orders  为指定 ID 对应用户添加一条订单信息。

// 需要的数据，传参 用户id,商品id，多个以逗号分隔

`cart.art`

```js
 <a class="sum-btn" href="javascript:;">结算</a>
结算的时候，需要注册事件，需要动态的把数据合到一起，然后发给后台


/**6. 结算*/
$('.sum-btn').on('click',function () {
    // 跳转地址为 /order/add?items=12,13
    // location.href=`/order/add?items=`+选中的商品id
    const items=[]
    $('.cart-list [type="checkbox"]:checked').each(function () {
        items.push(this.dataset.id)
    })
    // 如果没有选择商品，则阻止跳转
    if(!items.length) return
    location.href=`/order/add?items=`+items.join(',')

})

`order.js`中可以打印一下传参
// 生成订单
exports.addOrder = (req, res, next) => {
  // 生成订单  需要调接口
  // 需要的数据，传参 用户id,商品id，多个以逗号分隔
  console.log(req.query.items)
  res.redirect('/checkout')

}

```



### 06 支付-结算-生成订单完成

`models/order.js`

```js
// 订单相关的接口调用
const axios = require('./axiosInstance')
exports.add = (userId, items) => {
    // POST orders
    // https://ns-api.uieee.com/v1/orders
    return axios.post(`orders`, {
            user_id: userId,
            items
        })
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`controllers/order.js`

```js
// 定义订单相关路由函数
const orderModel = require('../models/order')
// 生成订单
exports.addOrder = (req, res, next) => {
  // 生成订单  需要调接口
  // 需要的数据，传参 用户id,商品id，多个以逗号分隔
  // console.log(req.query.items)
  const items = req.query.items
  // 在models/order.js中调接口
  orderModel.add(req.session.user.id, items)
    .then(order => {
      console.log(order)
      // 打印的order中有订单id和订单编号，我们需要传递一个唯一标识去订单核对页面，根据接口文档，GET orders/:num ，可知，我们在重定向的时候要传一个编号num，来到checkout才能根据订单信息，渲染页面，才能去核对
    }).catch(err => next(err))

  res.redirect('/checkout?num=' + order.order_number)

}
```



### 07 支付-结算-页面模版准备

`controllers/order.js`

```js
// 核对订单
exports.checkout = (req, res, next) => {
  // 核对订单(结算页面)
  // 结算页面需要订单信息，因为需要核对订单信息
  // res.send('ok')
  res.render('checkout.art')
}
```

`checkout.art`

```html
{{extend './lauout/common.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-cart.css">
{{/block}}
{{block 'script'}}
<script src="/assets/js/sui.modal.js"></script>
{{/block}}
{{block 'content'}}
  <!--主内容-->
  <div class="checkout py-container">
    <div class="checkout-tit"><h4 class="tit-txt">填写并核对订单信息</h4></div>
    <div class="checkout-steps">
      <!--收件人信息-->
      <div class="step-tit">
        <h5>
          <span>收件人信息</span>
          <a class="newadd" data-toggle="modal" data-target="#add_address" data-keyboard="false" href="#">新增收货地址</a>
        </h5>
      </div>
      <div class="step-cont">
        <div class="addressInfo">
          <ul class="addr-detail">
            <li class="addr-item selected">
              <div class="con name"><a href="#">张默</a></div>
              <div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span></div>
            </li>
            <li class="addr-item">
              <div class="con name"><a href="#">张默</a></div>
              <div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span></div>
            </li>
            <li class="addr-item">
              <div class="con name"><a href="#">张默</a></div>
              <div class="con address">张默 北京市海淀区三环内 中关村软件园9号楼 <span>159****3201</span></div>
            </li>
          </ul>
        </div>
        <div id="add_address" class="sui-modal hide fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button>
                <h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
              </div>
              <div class="modal-body">
                <form action="" class="sui-form form-horizontal">
                  <div class="control-group">
                    <label class="control-label">收货人：</label>
                    <div class="controls">
                      <input type="text" class="input-xfat">
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label">详细地址：</label>
                    <div class="controls">
                      <input type="text" class="input-xfat input-xlarge">
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label">手机：</label>
                    <div class="controls">
                      <input type="text" class="input-xfat">
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label">邮编：</label>
                    <div class="controls">
                      <input type="text" class="input-xfat">
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" data-ok="modal" class="sui-btn btn-primary btn-large">确定</button>
                <button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">取消</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="hr"></div>
      <!--支付和送货-->
      <div class="payshipInfo">
        <div class="step-tit">
          <h5>支付方式</h5>
        </div>
        <div class="step-cont">
          <ul class="payType">
            <li class="selected">微信</li>
            <li>支付宝</li>
          </ul>
        </div>
        <div class="hr"></div>
        <div class="step-tit">
          <h5>送货清单</h5>
        </div>
        <div class="step-cont">
          <ul class="send-detail">
            <li>
              <div class="sendGoods">
                <span>商品清单：</span>
                <ul class="yui3-g">
                  <li class="yui3-u-1-6">
                    <img src="/uploads/mobile.png">
                  </li>
                  <li class="yui3-u-2-3">
                    <div class="desc">Apple iPhone 6s (A1700) 64G 玫瑰金色 移动联通电信4G手机硅胶透明防摔软壳 本色系列</div>
                  </li>
                  <li class="yui3-u-1-12">
                    <div class="price">￥5399.00</div>
                  </li>
                  <li class="yui3-u-1-12">
                    <div class="num">x<strong>1</strong></div>
                  </li>
                </ul>
              </div>
            </li>
            <li></li>
            <li></li>
          </ul>
        </div>
        <div class="hr"></div>
      </div>
      <div class="linkInfo">
        <div class="step-tit">
          <h5>发票信息</h5>
        </div>
        <div class="step-cont">
          <span>普通发票（电子）</span>
          <span>个人</span>
          <span>明细</span>
        </div>
      </div>
    </div>
  </div>
  <div class="order-summary py-container">
    <div class="static fl"><i class="number">1</i> 件商品，总商品金额 <i>¥5399.00</i></div>
    <a class="sui-btn btn-danger btn-xlarge fr" href="pay.html">提交订单</a>
  </div>

{{/block}}
```

测试，可以在生成订单的时候，携带订单编号并返回静态页面

### 08 支付-结算-核对订单信息页面渲染

`models/order.js`

```js
// 查询单个订单
exports.item = (num) => {
    // GET orders/:num 
    // https://ns-api.uieee.com/v1/orders/:num
    return axios.get(`orders/${num}`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`controllers/order.js`

```js
// 核对订单
exports.checkout = (req, res, next) => {
  // 核对订单(结算页面)
  // 结算页面需要订单信息，因为需要核对订单信息
  orderModel.item(req.query.num)
    .then(order => {
      res.locals.order = order
      res.render('checkout.art')
    }).catch(err => next(err))
}
```

`checkout.art`

```html
新增
<div class="step-tit">
    <h5>
        <span>当前收件人信息</span>
    </h5>
</div>
<div class="step-cont">
    {{order.express_address}}
</div>

支付方式--改成支付宝
<ul class="payType">
    <li>微信</li>
    <li class="selected">支付宝</li>
</ul>

商品列表
<div class="sendGoods">
    <span>商品清单：</span>
    {{each order.products}}
    <ul class="yui3-g">
        <li class="yui3-u-1-6">
            <img src="{{$value.thumbnail}}">
        </li>
        <li class="yui3-u-2-3">
            <div class="desc">{{$value.name}}</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="price">￥{{$value.price}}</div>
        </li>
        <li class="yui3-u-1-12">
            <div class="num">x<strong>{{$value.amount}}</strong></div>
        </li>
    </ul>
    {{/each}}
</div>



<div class="order-summary py-container">
    <div class="static fl"><i class="number sui-text-danger">{{order.total_amount}}</i> 件商品，总商品金额 <i class="sui-text-danger">¥{{order.total_price}}</i></div>
    <a class="sui-btn btn-danger btn-xlarge fr" href="/pay">立即支付</a>
</div>
```



### 09 支付-开放平台-沙箱环境的信息了解

把支付宝加密的公钥和私钥拷贝到utils文件夹下

![1551922760689](C:\Users\初见\AppData\Roaming\Typora\typora-user-images\1551922760689.png)

### 10 支付-alipay-node-sdk封装一个获取支付地址的函数

npm i alipay-node-sdk (https://www.npmjs.com/package/alipay-node-sdk)

有提供给移动web端、PCWeb端等，创建实例的方式不同，根据文档创建

alipay-node-sdk的作用是拼接参数并加密，拼完参数发给支付宝网关，可以得到一个url，就是支付地址，把拿支付地址这件事封装在utils中

`alipay.js`

```js
// 获取支付地址=支付宝网关+加密后的参数，以问号拼接
// 支付宝网关+'?'+加密后的参数
const path = require('path')
/**1.使用第三方包 alipay-node-sdk */
const Alipay = require('alipay-node-sdk')
/**2. 得到构造函数，实例化后，去对参数进行加密*/
const alipay = new Alipay({
    // appId 应用ID
    appId: '2016092300579138',
    // notifyUrl 通知地址
    notifyUrl: 'http://127.0.0.1:3000/pay/notify',
    // 私钥路径
    rsaPrivate: path.join(__dirname, '/rsa_private_key.pem'),
    // 公钥
    rsaPublic: path.join(__dirname, '/rsa_public_key.pem'),
    // 是否是测试环境
    sandbox: true,
    // 加密算法到的类型
    signType: 'RSA2'
});

exports.getPayUrl = (order) => {
    /**3.通过以上实例可以对参数进行加密 */
    /**4.每个订单不一样，参数不一样 */
    const params = alipay.pagePay({
        // subjectz支付标题
        subject: '品优购商品',
        // body具体哪一些商品，所有商品名称，每个商品换一行
        body: order.products.map((item, i) => item.name).join('\n'),
        // outTradeId 商户的交易编号
        outTradeId: order.order_number,
        // timeout支付超时时间
        timeout: '10m',
        // amount支付金额
        amount: order.total_price,
        // goodsType商品类型 虚拟0 实物 1
        goodsType: '1',
        // qrPayMode二维码支付模式，确定二维码的类型
        // [opts.qrPayMode]          PC扫码支付的方式，支持前置模式和跳转模式。前置模式是将二维码前置到商户的订单确认页的模式，需要商户在自己的页面中以 iframe 方式请求支付宝页面。详见https://www.npmjs.com/package/alipay-node-sdk
        qrPayMode: 2
    });
    return 'https://openapi.alipaydev.com/gateway.do?' + params
}
```



### 11 支付-走通支付宝扫码页面

`router.js`

```js
const payController = require('./controllers/pay')
// 支付相关的路由
router.get('/pay', middlewares.checkLogin, payController.pay)
```

获取订单信息 需要订单编号 ，点击立即支付的时候传递订单编号

`checkout.art`

```js
<a class="sui-btn btn-danger btn-xlarge fr" href="/pay?num={{order.order_number}}">立即支付</a>
```

`controllers/pay.js`

```js
const orderModel = require('../models/order')
const alipay = require('../utils/alipay')
exports.pay = (req, res, next) => {
    // 进行支付
    // 获取订单信息 需要订单编号 ，点击立即支付的时候传递订单编号
    const num = req.query.num
    // 根据订单编号获取订单信息
    orderModel.item(num)
        .then(order => {
            // 获取支付地址
            const url = alipay.getPayUrl(order)
            // 跳转支付宝
            res.redirect(url)
        }).catch(err => next(err))
}
```

点击立即支付，可以调到支付宝，扫码付款成功之后，应该调回订单页面，但是目前不能



### 12 支付-走通支付宝回调自己的成功页面

`alipay.js`添加选项：

```js
// 客户端回调地址
return_url: 'http://127.0.0.1:3000/pay/callback'
```

测试，支付成功之后，可以回跳，目前还没渲染

### 13 支付-在回调的路由去修改订单的状态返回数据

`router.js`

```js
router.get('/pay/callback', middlewares.checkLogin, payController.callback)
```

`controllers/pay.js`

```js
exports.callback = (req, res, next) => {
    // 订单之前的状态是未付款，如果能成功的回跳过来，需要把状态改成已付款，再把订单信息展示出来
    // 修改订单的状态
    // 修改订单 接口  PATCH orders/:num
    // 获取订单编号 req.query.out_trade_no
    // 获取支付宝流水 req.query.trade_no
    const out_trade_no = req.query.out_trade_no
    const trade_no = req.query.trade_no
    // 支付状态，1是已支付、
    orderModel.edit(out_trade_no, 1, trade_no)
        .then(order => {
            // 成功提示  订单信息 页面展示
            res.locals.order = order
            res.render('paySuccess.art')
        }).catch(err => next(err))
}
```

`models/order.js`

```js
// 修改单个订单
// PATCH orders/:num 
// https://ns-api.uieee.com/v1/orders/:num
exports.edit = (num, pay_status, trade_no) => {
    // GET orders/:num 
    // https://ns-api.uieee.com/v1/orders/:num
    return axios.pacth(`orders/${num}`, {
            pay_status,
            trade_no
        })
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```



### 14 支付-支付成功的提示页面渲染

`paySuccess.art`

```html
{{extend './lauout/common.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-cart.css">
{{/block}}
{{block 'script'}}
<script src="/assets/js/sui.modal.js"></script>
{{/block}}
{{block 'content'}}
<!--主内容-->
<div class="checkout py-container">
    <div class="sui-msg msg-large msg-block msg-success">
        <div class="msg-con">恭喜您支付成功！<a href="/order">全部订单</a> </div>
        <s class="msg-icon"></s>
    </div>
    <div class="checkout-tit">
        <h4 class="tit-txt">填写并核对订单信息</h4>
    </div>
    <div class="checkout-steps">
        <!--收件人信息-->
        <div class="step-tit">
            <h5>
                <span>当前收件人信息</span>
            </h5>
        </div>
        <div class="step-cont">
            {{order.express_address}}
        </div>
        <div class="hr"></div>
        <!--支付和送货-->
        <div class="payshipInfo">
            <div class="step-tit">
                <h5>支付方式</h5>
            </div>
            <div class="step-cont">
                <ul class="payType">
                    <li class="selected">支付宝</li>
                </ul>
            </div>
            <div class="hr"></div>
            <div class="step-tit">
                <h5>送货清单</h5>
            </div>
            <div class="step-cont">
                <ul class="send-detail">
                    <li>
                        <div class="sendGoods">
                            <span>商品清单：</span>
                            {{each order.products}}
                            <ul class="yui3-g">
                                <li class="yui3-u-1-6">
                                    <img src="{{$value.thumbnail}}">
                                </li>
                                <li class="yui3-u-2-3">
                                    <div class="desc">{{$value.name}}</div>
                                </li>
                                <li class="yui3-u-1-12">
                                    <div class="price">￥{{$value.price}}</div>
                                </li>
                                <li class="yui3-u-1-12">
                                    <div class="num">x<strong>{{$value.amount}}</strong></div>
                                </li>
                            </ul>
                            {{/each}}
                        </div>
                    </li>
                    <li></li>
                    <li></li>
                </ul>
            </div>
            <div class="hr"></div>
        </div>
        <div class="linkInfo">
            <div class="step-tit">
                <h5>发票信息</h5>
            </div>
            <div class="step-cont">
                <span>普通发票（电子）</span>
                <span>个人</span>
                <span>明细</span>
            </div>
        </div>
    </div>
</div>
<div class="order-summary py-container">
    <div class="static fl"><i class="number sui-text-danger">{{order.total_amount}}</i> 件商品，总商品金额 <i class="sui-text-danger">¥{{order.total_price}}</i></div>
</div>

{{/block}}
```



### 15 订单-订单列表模版准备

`router.js`

```js
router.get('/order', middlewares.checkLogin, orderController.list) //全部订单
```

`controllers/order.js`

```js
// 全部订单
exports.list = (req, res, next) => {
  // 获取全部订单数据
  // 渲染模板
  res.render('order.art')
}
```

`order.art `参考public中的member-order.html

```html
{{extend './lauout/common.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-member.css">
{{/block}}
{{block 'script'}}
<script src="/assets/js/sui.modal.js"></script>
{{/block}}
{{block 'content'}}
<div class="py-container">
    <div class="yui3-g home">
        <!--左侧列表-->
        <div class="yui3-u-1-6 list">
            <dl>
                <dt><i>·</i> 订单中心</dt>
                <dd><a href="member-order.html">我的订单</a></dd>
                <dd>团购订单</dd>
                <dd>本地生活订单</dd>
                <dd>我的预售</dd>
                <dd>评价晒单</dd>
                <dd>取消订单记录</dd>
            </dl>
            <dl>
                <dt><i>·</i> 关注中心</dt>
                <dd>关注的商品</dd>
                <dd>关注的店铺</dd>
                <dd>关注的专辑</dd>
                <dd>关注的品牌</dd>
                <dd>关注的活动</dd>
                <dd>浏览历史</dd>
            </dl>
            <dl>
                <dt><i>·</i> 客户服务</dt>
                <dd>返修退换货</dd>
                <dd>价格保护</dd>
                <dd>意见建议</dd>
                <dd>购买咨询</dd>
                <dd>交易纠纷</dd>
                <dd>我的发票</dd>
            </dl>
            <dl>
                <dt><i>·</i> 设置</dt>
                <dd><a href="member-profile.html">个人信息</a></dd>
                <dd><a href="member-address.html">收货地址</a></dd>
            </dl>
        </div>
        <!--右侧主内容-->
        <div class="yui3-u-5-6 body">
            <div class="order-detail">
                <div class="ever">

                    <div id="all" class="tab-pane active">
                        <div class="orders">
                            <table class="sui-table table-bordered">
                                <thead>
                                    <tr>
                                        <th colspan="4">
                                            <span class="ordertitle">2017-02-11 11:59　订单编号：7867473872181848</span>
                                            <span class="pull-right delete"><img src="/assets/img/delete.png"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="goods-info">
                                                <img src="/uploads/mobile.png" height="100">
                                                <a href="#" class="block-text">包邮 正品玛姬儿压缩面膜无纺布纸膜100粒 送泡瓶面膜刷喷瓶 新款</a>
                                                <span>x1</span>
                                            </div>
                                            <div class="goods-info">
                                                <img src="/uploads/mobile.png" height="100">
                                                <a href="#" class="block-text">包邮 正品玛姬儿压缩面膜无纺布纸膜100粒 送泡瓶面膜刷喷瓶 新款</a>
                                                <span>x1</span>
                                            </div>
                                        </td>
                                        <td width="10%" class="center">小丽</td>
                                        <td width="13%" class="center">
                                            <p>总金额¥138.00</p>
                                            <p>在线支付</p>
                                        </td>
                                        <td width="10%" class="center">已完成</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{{/block}}
```



### 16 订单-查看

`models/order.js`

```js
// 查询全部订单
// GET orders 
// https://ns-api.uieee.com/v1/orders?user_id=1
exports.alllist = (userId) => {
    return axios.get(`orders?user_id=${userId}`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

`controllers/order.js`

```js
// 全部订单
exports.list = (req, res, next) => {
  // 获取全部订单数据
  orderModel.alllist(req.session.user.id)
    .then(list => {
      res.locals.list = list
      // 渲染模板
      res.render('order.art')
    }).catch(err => next(err))
}
```

`order.art`

```html
{{extend './lauout/common.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-member.css">
{{/block}}
{{block 'script'}}
<script src="/assets/js/sui.modal.js"></script>
{{/block}}
{{block 'content'}}
<div class="py-container">
    <div class="yui3-g home">
        <!--左侧列表-->
        <div class="yui3-u-1-6 list">
            <dl>
                <dt><i>·</i> 订单中心</dt>
                <dd><a href="member-order.html">我的订单</a></dd>
                <dd>团购订单</dd>
                <dd>本地生活订单</dd>
                <dd>我的预售</dd>
                <dd>评价晒单</dd>
                <dd>取消订单记录</dd>
            </dl>
            <dl>
                <dt><i>·</i> 关注中心</dt>
                <dd>关注的商品</dd>
                <dd>关注的店铺</dd>
                <dd>关注的专辑</dd>
                <dd>关注的品牌</dd>
                <dd>关注的活动</dd>
                <dd>浏览历史</dd>
            </dl>
            <dl>
                <dt><i>·</i> 客户服务</dt>
                <dd>返修退换货</dd>
                <dd>价格保护</dd>
                <dd>意见建议</dd>
                <dd>购买咨询</dd>
                <dd>交易纠纷</dd>
                <dd>我的发票</dd>
            </dl>
            <dl>
                <dt><i>·</i> 设置</dt>
                <dd><a href="member-profile.html">个人信息</a></dd>
                <dd><a href="member-address.html">收货地址</a></dd>
            </dl>
        </div>
        <!--右侧主内容-->
        <div class="yui3-u-5-6 body">
            <div class="order-detail">
                <div class="ever">

                    <div id="all" class="tab-pane active">
                        {{each list order i}}
                        <div class="orders">
                            <table class="sui-table table-bordered">
                                <thead>
                                    <tr>
                                        <th colspan="4">
                                            <span class="ordertitle">{{order.create_time}}　订单编号：{{order.order_number}}</span>
                                            <span class="pull-right delete"><img src="/assets/img/delete.png"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            {{each order.products }}
                                            <div class="goods-info">
                                                <img src="{{$value.thumbnail}}" height="100">
                                                <a href="#" class="block-text">{{$value.name}}</a>
                                                <span>x{{$value.amount}}</span>
                                            </div>
                                            {{/each}}
                                        </td>
                                        <td width="10%" class="center">{{order.express_address}}</td>
                                        <td width="13%" class="center">
                                            <p>总金额¥{{order.total_price}}</p>
                                            <p>在线支付</p>
                                        </td>
                                        <td width="10%" class="center">{{order.pay_status}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {{/each}}
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{{/block}}
```





### 

### 

### 

### 









































   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   













